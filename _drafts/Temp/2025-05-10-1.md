---
layout: default_post
title: "0093. 開發環境部署 - Kafka 使用 Kraft 模式，模擬高可用"
excerpt: "C# 學習筆記"
tags: 
- "Docker"
- "Docker-Compose"
- "Container"
- "Ubuntu"
- "Linux"
- "Kafka"
- "Kafka UI"
---

<div class="summary">
<br/>應用所需：1. Linux Ubuntu (本篇 22.04)
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. 已安裝 Docker
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;3. Kafka UI 管理介面已安裝
<br/>解決問題：1. 介紹 Kafka 3.8.0 版本以後的 Kraft模式與 Zookper 管理集群的差異
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. 如何在開發環境中切出 3個 Broker 副本，模擬生產架構
<br/>相關參考：<a href="https://gotoa1234.github.io/2025/04/05/1.html">0089. Linux Ubuntu 上使用 Docker Compose 快速部署 Kafka</a>
<br/>基本介紹：本篇分為 3 部分。
<br/>第一部分：安裝 Kafka 3.8.0 與 KRaft 模式介紹
<br/>第二部分：開發環境 - 單點多 Broker & 部署配置
<br/>第三部分：DEMO 單機多副本因子高可用

</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>

<br/><br/>

<h1>安裝 Kafka 3.8.0 與 KRaft 模式介紹</h1>

<h2>Step 1：Kafka 的 KRaft 模式介紹</h2>


<br/>
<br/> <img src="/assets/image/LearnNote/2025_05_10/001.png" alt="" width="100%" height="100%" />
<br/><br/>



<h2>Step 2：KRaft 與 Zookeeper 差異</h2>


<br/>
<br/> <img src="/assets/image/LearnNote/2025_05_10/001.png" alt="" width="100%" height="100%" />
<br/><br/>


<h2>Step 3：Kafak 支持模式的版本迭代說明</h2>


<br/>
<br/> <img src="/assets/image/LearnNote/2025_05_10/001.png" alt="" width="100%" height="100%" />
<br/><br/>


<h2>Step 2：Kafka 特點</h2>
Kafka <a href="https://github.com/apache/kafka">官方Github</a>，並且有以下特點

{:class="table table-bordered"}
| 1. 高吞吐量 | 能夠處理高容量的數據流，每秒處理數百萬條消息 |
| 2. 持久性儲存 | 數據可以持久化到磁盤，提供數據安全性 |
| 3. 分散式架構 | 可以橫向擴展，增加節點來提高處理能力 |
| 4. 容錯性 | 具有高可用性和容錯能力，確保數據不會丟失 |
| 5. 實時處理 | 支持實時數據處理與分析 |
| 6. 企業級傾向 | 支持橫向擴展，因此適合用於企業級消息系統，構建大型專案、產品 |
| 7. 完全開源 | 免費，遵循 Apache 2.0 許可證，代碼庫託管在 GitHub 上 |

<br/>※ Apache 2.0 許可證： 非常寬鬆的開源許可證，可以商業免費使用
<br/><br/>





<h1>第二部分：開發環境 - 單點多 Broker & 部署配置 </h1>
<h2>Step 1：Docker-Comopse 檔案說明</h2>
<a href="https://github.com/gotoa1234/MyBlogExample/blob/main/KafkaAspCoreWebExample/docker-compose.yml">docker-compose.yml</a>有以下腳本，分別實現以下 3 個項目的容器化安裝：

{:class="table table-bordered"}
| 項目 | 項目 |
| --- | --- |
| zookeeper | Kafka 分散式協調機制的核心管理，使用 2181 Port |
|           | 重啟策略  unless-stopped (表示故障, Crash 後自動重啟, 除了手動停止 ) |
| kafka     | 訊息中介軟體 (Message Broker)，將訊息推送 zookeeper 管理 |
|           | 使用 9092 Port，並且配置自己的主機位置，綁定的 zookeeper 的 Port  |
|           | 重啟策略  unless-stopped (表示故障, Crash 後自動重啟, 除了手動停止 ) |
| kafka-ui  | 提供 kafka 介面化檢視、操作；對外的 Web 操作是開放 8380 Port  |
|           | 依賴於 zookeeper、kafka 收集這 2 個服務資訊 |


``` yml
version: '3'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    restart: unless-stopped

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: localhost
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "test-topic:1:1"
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - zookeeper
    restart: unless-stopped

  kafka-ui:
    image: provectuslabs/kafka-ui
    container_name: kafka-ui
    ports:
      - "8380:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181
    depends_on:
      - kafka
      - zookeeper
```

<br/>其中這邊的 localhsot 一定要改成自己主機的 IP  EX: 我的內部主機用 192.168.51.100
<br/>否則 Kafka-ui 會無法正確訪問到路徑
<br/>從以下：

``` markdown
KAFKA_ADVERTISED_HOST_NAME: localhost
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
```

<br/>改成以下：

``` markdown
KAFKA_ADVERTISED_HOST_NAME: 192.168.51.100
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:// 192.168.51.100:9092
```


<br/><br/>








<h1>第三部分：DEMO 單機多副本因子高可用</h1>
<h2>Step 1：Docker-Comopse 檔案說明</h2>
<a href="https://github.com/gotoa1234/MyBlogExample/blob/main/KafkaAspCoreWebExample/docker-compose.yml">docker-compose.yml</a>有以下腳本，分別實現以下 3 個項目的容器化安裝：

{:class="table table-bordered"}
| 項目 | 項目 |
| --- | --- |
| zookeeper | Kafka 分散式協調機制的核心管理，使用 2181 Port |
|           | 重啟策略  unless-stopped (表示故障, Crash 後自動重啟, 除了手動停止 ) |
| kafka     | 訊息中介軟體 (Message Broker)，將訊息推送 zookeeper 管理 |
|           | 使用 9092 Port，並且配置自己的主機位置，綁定的 zookeeper 的 Port  |
|           | 重啟策略  unless-stopped (表示故障, Crash 後自動重啟, 除了手動停止 ) |
| kafka-ui  | 提供 kafka 介面化檢視、操作；對外的 Web 操作是開放 8380 Port  |
|           | 依賴於 zookeeper、kafka 收集這 2 個服務資訊 |


``` yml
version: '3'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    restart: unless-stopped

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: localhost
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "test-topic:1:1"
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - zookeeper
    restart: unless-stopped

  kafka-ui:
    image: provectuslabs/kafka-ui
    container_name: kafka-ui
    ports:
      - "8380:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181
    depends_on:
      - kafka
      - zookeeper
```

<br/>其中這邊的 localhsot 一定要改成自己主機的 IP  EX: 我的內部主機用 192.168.51.100
<br/>否則 Kafka-ui 會無法正確訪問到路徑
<br/>從以下：

``` markdown
KAFKA_ADVERTISED_HOST_NAME: localhost
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
```

<br/>改成以下：

``` markdown
KAFKA_ADVERTISED_HOST_NAME: 192.168.51.100
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:// 192.168.51.100:9092
```


<br/><br/>


