---
layout: default_post
title:  "0014. 搭建 Grafana - 監控機器"
excerpt: "資訊筆記"
tags: 
- "Linux"
- "Ubuntu"
- "Grafana"
- "Prometheus"
- "Node Exporter"
---

<div class="summary">
<br/>應用所需：1. Linux 主機(本篇 Linux Ubuntu 22.04 作業系統)
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. 已安裝 Docker
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;3. 已安裝 Dotnet SDK 8.0 以上版本(本篇範例使用)
<br/>解決問題：如何在 Ubuntu 上容器化搭建資料視覺化和監控平台套件 Grafana ，協助檢查代碼品質，將複雜的資料轉換成易於理解的視覺化圖表和儀表板
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. 如何設定 Prometheus 做為資料源，進行監控
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;3. 介紹 Prometheus、Node Exporter (監控機器資源必需的套件)
<br/>範例檔案：<a href="https://github.com/gotoa1234/MyBlogExample/tree/main/MinIOWebSiteExample">MinIO WebSite 範例</a>
<br/>基本介紹：本篇分為 4 大部分。
<br/>第一部分：介紹監控 Grafana
<br/>第二部分：介紹相依套件 Prometheus
<br/>第三部分：介紹相依套件 Node Exporter
<br/>第四部分：安裝 Grafana & DEMO監控機器資源
</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>

<br/><br/>
<h1>第一部分：介紹 Grafana </h1>

<h2>Step 1：介紹</h2>
Grafana<a href="https://grafana.com/zh-cn/grafana/">中文官網</a>

``` Markdown
查询、可视化和理解数据，并获取数据警报，无论数据存储在何处。
在 Grafana，您可以通过美观、灵活的数据面板创建、探索和共享所有数据。
```

<br/>簡單說：Grafana 的強大在於跟任何數據來源都能很好的支援，只負責獲取資料，呈現視覺化的圖表。
<br/> <img src="/assets/image/Infomation/2025_05_03/002.png" alt="" width="100%" height="100%" />
<br/>

<h2>Step 2：收費價格</h2>
付費方案分成 Grafana OSS(開源免費)、Grafana Enterprise(企業付費版)

{:class="table table-bordered"}
|     | Grafana OSS | Grafana Enterprise |
| --- | --- | --- |
| 可視化與監控 | 核心儀表板功能 | 相同，並有額外優化 |
| 數據來源支援 | 支援 Prometheus, Loki, InfluxDB, Elasticsearch 等 | 企業級數據來源（如 Splunk ...) |
| 用戶權限管理 | 只有基本角色（Admin/Editor/Viewer） | 有，更進階 |
| SSO / LDAP 整合 | 需手動設定 | 建 SSO（Google SSO 等） |
| 報告功能 | 沒有 | 內建 PDF / CSV 報告排程 |
| 日誌  | 沒有 | 追蹤使用者行為 |
| 儀表板快取 | 沒有 | 有、效能好 |
| 技術支援 | 論壇、GitHub | 企業級技術支援（SLA 保障） |
| 價格 | 免費  | 可參考官網報價(極貴) |

<br/>以上是兩者的差異，如果是小型專案免費版基本上夠用，如果是大型企業才會有需要考慮更高效能的監控、報告
<br/><a href="https://grafana.com/pricing/">官網報價</a>
<br/>


<h2>Step 3：免費版開源配置限制</h2>
官網<a href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/">安裝指南</a>資訊，有建議安裝需求：
<br/>以下是最低限制：

``` markdown
Hardware recommendations
Grafana requires the minimum system resources:

Minimum recommended memory: 512 MB
Minimum recommended CPU: 1 core
Some features might require more memory or CPUs, including:
```

{:class="table table-bordered"}
| 1. 記憶體 512 MB |
| 2. 最小CPU 1 核心 |

<br/>Grafana 的強大之處就在於只是收集資料的中繼點，耗費效能的事情都是資料來源的伺服器要煩惱的事情。
<br/> <img src="/assets/image/Infomation/2025_05_03/000.png" alt="" width="100%" height="100%" />
<br/>



<h2>Step 4：支援的資料來源與查詢對應</h2>

<br/> <img src="/assets/image/Infomation/2025_05_03/000.png" alt="" width="100%" height="100%" />
<br/>



<h2>Step 5：免費開源版 - 相依套件</h2>

<br/> <img src="/assets/image/Infomation/2025_05_03/000.png" alt="" width="100%" height="100%" />
<br/>





<br/><br/>
<h1>第二部分：介紹相依套件 Prometheus </h1>

<h2>Step 1：建立 DockerCompose</h2>
先進入 Ubuntu 主機上，新建以下 DockerCompose.yml 檔案，內容如下：

``` yml
   
```

<br/> <img src="/assets/image/Infomation/2025_05_03/000.png" alt="" width="100%" height="100%" />
<br/>



<br/><br/>
<h1>第三部分：介紹相依套件 Node Exporter</h1>

<h2>Step 1：開啟 WebUI</h2>
依照自己主機的位置，可以輸入對應的 IP + Port 號進入管理介面

``` html
http://192.168.51.28:9100/
```

<br/>預設帳號密碼都是以下：

{:class="table table-bordered"}
| 帳號: admin |
| 密碼: admin |

<br/> <img src="/assets/image/Infomation/2025_01_25/006.png" alt="" width="50%" height="50%" />
<br/>



<br/><br/>
<h1>第四部分：安裝 Grafana & DEMO監控機器資源</h1>

<h2>Step 1：建立 DockerCompose</h2>
先進入 Ubuntu 主機上，新建以下 DockerCompose.yml 檔案，內容如下：

``` yml
version: '3'
services:
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9200:9090"  # 外部使用 9200 連接到內部的 9090
    networks:
      - grafana-net

  node-exporter:
    image: prom/node-exporter
    container_name: node-exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "9201:9100"  # 外部使用 9201 連接到內部的 9100
    networks:
      - grafana-net

  grafana:
    image: grafana/grafana
    container_name: grafana
    restart: unless-stopped
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "9202:3000"  # 外部使用 9202 連接到內部的 3000
    networks:
      - grafana-net
    depends_on:
      - prometheus

volumes:
  prometheus_data:
  grafana_data:

networks:
  grafana-net:
```

<br/>為了說明，Port 有自定義，對應如下：

{:class="table table-bordered"}
| Prometheus | 9200 |
| Node Exporter | 9201 |
| Grafana | 9202 |

<br/> <img src="/assets/image/Infomation/2025_05_03/004.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 2：建立 prometheus 設定檔案</h2>
接著在 Ubuntu 上建立 promethues 的配置檔案，要與 Node Exporter 取得資料
<br/>這邊 Node Exporter 用 9100 是對應的 Container 內部的 Port 號，而非宿主機的 9201
<br/>便於容器內網路相互溝通

``` yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']

```

在對應的位置貼上 Container 綁定的 Volumn
<br/> <img src="/assets/image/Infomation/2025_05_03/005.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 3：啟動 Docker-Compose</h2>
在對應目錄上執行 docker-compose.yml 檔案進行安裝
<br/>該範例對應 **\louistemp\grafana\** 目錄

``` shell
docker docker-compose.yml -u -p
```

<br/> <img src="/assets/image/Infomation/2025_05_03/003.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 4：檢查容器運行狀況</h2>
正常運行後，可以執行以下，或進入 Portainer 觀察容器運行

``` shell
docker ps -a
```

<br/> <img src="/assets/image/Infomation/2025_05_03/006.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 5：進入 Grafana WebUI</h2>
接著開啟瀏覽器，登入 Grafana 容器提供的 Web URL

``` html
http://192.168.1.100:9202/Login
```

<br/>帳號密碼預設為 :  admin
<br/> <img src="/assets/image/Infomation/2025_05_03/007.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 6：配置 Prometheus 為資料來源</h2>
要可視覺化 **CPU, 記憶體** 硬體配置運行資源，需要以 Prometheus 做為資料來源 
<br/>左側 Menu -> Connections -> Data Source
<br/> <img src="/assets/image/Infomation/2025_05_03/008.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 7：配置 Prometheus 為資料來源 - 增加來源</h2>
點開後，執行中間的按鈕 -> Add Data Source
<br/> <img src="/assets/image/Infomation/2025_05_03/009.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 8：配置 Prometheus 為資料來源 - 選擇</h2>
選擇 Prometheus 當來源
<br/> <img src="/assets/image/Infomation/2025_05_03/010.png" alt="" width="100%" height="100%" />
<br/>

<h2>Step 9：配置 Prometheus 為資料來源 - 配置 API 位置</h2>
為了讓 Grafana 可以得到 Prometheus 的資料，因此要讓 Grafana 訪問 Prometheus 的 API
<br/>在 Connection 的地方輸入對應的 API URL

```
http://192.168.1.100/
```

<br/> <img src="/assets/image/Infomation/2025_05_03/012.png" alt="" width="100%" height="100%" />
<br/>

<h2>Step 10：配置 Prometheus 為資料來源 - 測試配置</h2>
拉到最下方，點擊按鈕 **Save & Test**，成功的話會出現 **Successfuly ...** 的訊息
<br/>資料來源有了後，就可以透過 Prometheus 查詢歷史資料
<br/> <img src="/assets/image/Infomation/2025_05_03/013.png" alt="" width="100%" height="100%" />
<br/>


<h2>Step 11：確定 Node Exporter 的 ID</h2>
可以進入 <a href="https://grafana.com/grafana/dashboards/">Grafana 官網的 DashBoard 套件查詢</a>
<br/>輸入 Node Exporter 後，可以在 URL 看到 ID 號碼
<br/> <img src="/assets/image/Infomation/2025_05_03/016.png" alt="" width="100%" height="100%" />
<br/>

<h2>Step 12：Grafana儀錶板 - 配置 Node Exporter - 視覺化指標</h2>
為了要能在 Grafana 儀表表看到視覺化資料，需要在 DashBoard Import Node Exporter 
<br/> <img src="/assets/image/Infomation/2025_05_03/014.png" alt="" width="100%" height="100%" />
<br/>




<h2>Step 13：儀錶板 - 配置 Node Exporter - 設定2</h2>
**Node Exporter** 對應 ID 為 1860 ，直接輸入
<br/> <img src="/assets/image/Infomation/2025_05_03/017.png" alt="" width="100%" height="100%" />
<br/>

<h2>Step 14：[補充] DashBaord 的套件 ID 如何查詢</h2>
以 **Node Exporter** 為例，可以在
<br/> <img src="/assets/image/Infomation/2025_05_03/016.png" alt="" width="100%" height="100%" />
<br/>