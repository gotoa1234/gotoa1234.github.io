---
layout: default_post
title: "0095. Kafka 水平擴展消費處理 - 主主架構(Multi-Master)，如何實現與配置方式"
excerpt: "C# 學習筆記"
tags: 
- "Docker"
- "Docker-Compose"
- "Container"
- "Ubuntu"
- "Linux"
- "Kafka"
- "Kafka UI"
- "Multi Master Service"
---

<div class="summary">
<br/>應用所需：1. Linux Ubuntu (本篇 22.04)
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. 已安裝 Docker、Kafka、Kafka-UI
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;3. Visual Studio 2022 以上版本
<br/>解決問題：1. 如何實現主主服務架構下，多個伺服器同時消費 Kafka 的訊息隊列，並且每個主服務處理相同的生產者群組隊列的訊息時，每個主服務不會重複處理
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. 展示在主主服務架構下 Kafka 的 Consumer 如何自動實現負載均衡
<br/>相關參考：<a href="https://gotoa1234.github.io/2025/04/05/1.html">0089. Linux Ubuntu 上使用 Docker Compose 快速部署 Kafka</a>
<br/>相關參考：<a href="https://gotoa1234.github.io/2025/04/12/1.html">0090. Kafka 開發指南：.NET Core 上 Kafka 事件流(消息隊列)推送</a>
<br/>相關參考：<a href="https://gotoa1234.github.io/2025/05/10/1.html">0093. Kafka Kraft 模式部署與高可用性模擬測試（附完整 docker-compose）</a>
<br/>範例專案：<a href="https://github.com/gotoa1234/MyBlogExample/tree/main/KafkaMultiMasterServerExample">範例代碼</a>
<br/>基本介紹：本篇分為 3 部分。
<br/>第一部分：Kafka - 主主服務架構
<br/>第二部分：Web專案架構
<br/>第三部分：代碼說明
<br/>第四部分：DEMO 成果 - 主主服務架構 - 不重複消費
<br/>第五部分：DEMO 成果 - 主主服務架構 - 自動負載均衡

</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>

<br/><br/>

<h1>第一部分：Kafka - 主主服務架構</h1>

<h2>Step 1：Kafka 適合主主架構簡介</h2>
有以下 Kafka 本身的特性，因此適合主主服務，其中最關鍵的是粗體字的部分。

{:class="table table-bordered"}
| 1.Consumer Group 機制 | 自動負載均衡分配 | 
|                       | **消息不會重複消費** | 
|                       | 故障自動轉移 | 
| 2. 分區機制 | 天然的並行處理能力 | 
|            | 每個分區只分配給一個消費者 | 
|            | **支持水平擴展** | 
| 3. 偏移量管理 | 精確控制消息處理進度 | 
|              | **支持手動提交** | 
|              | 故障恢復不丟失消息 | 


<br/><br/>

<h2>Step 2：主主 vs 主從架構比較</h2>

<br/> <img src="/assets/image/LearnNote/2025_06_14/002.png" alt="" width="100%" height="100%" />
<br/><br/>



<h2>Step 3：主主架構下的 - 生產者與消費者</h2>

<br/> <img src="/assets/image/LearnNote/2025_06_14/002.png" alt="" width="100%" height="100%" />
<br/><br/>




<h1>第二部分：Web專案架構</h1>

<h2>Step 1：範例專案架構</h2>
打開<a href="https://github.com/gotoa1234/MyBlogExample/tree/main/KafkaAspCoreWebExample">範例代碼</a>後，架構基本分成以下：

{:class="table table-bordered"}
| 1. Service - BackGround | ： | 背景服務，持續輪詢 Kafka 持續消費指定的 TopicName 將資料寫進此 AP | 
| 2. Service - Producer | ： | 生產者模式，發送訊息到指定的 Kafka Broker + TopicName 上  | 
| 3. Service - Consumer  | ： | 消費者模式，這邊的服務是將從背景服務取到的消費者資料回傳給 Web控制器，用以渲染 | 
| 4. Web控制器  | ： | 提供生產者發送訊息 & 頁面 與 消費者檢視頁面 | 
| 5. Html 畫面  | ： | 提供 Html 畫面取資料、並且可發送訊息給 Kafka  | 
| 6. 參數配置  | ： | 配置 Kafka 的目標 Server Host ，發送的 TopicName 與自己應用端的消費者群組Id | 
| 7. 初始化配置  | ： | 基本的依賴注入，並且引用 Kafka Confluent 套件，並註冊背景服務  | 

<br/> <img src="/assets/image/LearnNote/2025_06_14/002.png" alt="" width="100%" height="100%" />
<br/><br/>



<h1>第三部分：代碼說明</h1>

<h2>Step 1： Service - BackGround</h2>
若想要詳細的 Kafka 操作，可以參考<a href="https://kafka.apache.org/documentation/">官方的開發文件</a>，官方寫的非常詳細。
<br/>※這篇以開發導向，能**快速將代碼與 Kafka 服務器作互動為目標**。
<br/>背景服務會持續輪詢 Kafka ，並將生產者的訊息進行持續消費
<br/>方法分成持續進行、關閉時。

<br/><br/>




<h1>第四部分：DEMO 成果 - 主主服務架構 - 不重複消費</h1>

<h2>Step 1：啟動專案</h2>
使用 Visual Studio 開啟專案 -> 進入 Debug 模式 -> 進入 Kafka 首頁 -> 會有 2 個頁面可以操作
<br/> <img src="/assets/image/LearnNote/2025_06_14/002.png" alt="" width="100%" height="100%" />
<br/><br/>


<h1>第四部分：DEMO 成果 - 主主服務架構 - 自動負載均衡</h1>

<h2>Step 1：啟動專案</h2>
使用 Visual Studio 開啟專案 -> 進入 Debug 模式 -> 進入 Kafka 首頁 -> 會有 2 個頁面可以操作
<br/> <img src="/assets/image/LearnNote/2025_06_14/002.png" alt="" width="100%" height="100%" />
<br/><br/>
