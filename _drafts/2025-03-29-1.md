---
layout: default_post
title:  "0001. 資料庫分散式架構 - 實現強一致性 XA 協議 (eXtended Architecture，XA) - C# 範例並搭配 Mysql 資料庫實作"
excerpt: "資料庫分散式架構"
tags:
  - "Docker"
  - "Docker-Compose"
  - "Container"
  - "Ubuntu"
  - "Linux"
  - "MySQL"
  - "Asp.NET Core Web MVC"
---
<div class="summary">
<br/>應用所需：1. Visual Studio 2022 以上
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. Mysql Database 8.0 以上並且有 2 個資料庫實例
<br/>程式說明：分散式資料庫架構 - XA 協議說明、介紹、應用方式
<br/>範例檔案：<a href="https://github.com/gotoa1234/PythonTetris.git">Githu連結</a>
<br/>基本介紹：本篇分為 4 大部分。
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;
<br/>第一部分：資料庫分散式架構維度簡介
<br/>第二部分：XA 協議概述
<br/>第三部分：XA 優缺點 &工作原理 
<br/>第四部分：XA 範例實作
</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>



<br/><br/>
<h1>第一部分：資料庫分散式架構簡介</h1>
<h2>Step 1：資料庫分散式 - 簡介</h2>

``` markdwon
分散式資料庫是一個邏輯上統一但實際上分散在不同地理位置的資料庫系統。

它將資料分散儲存在多個實體位置的資料庫中,這些資料庫透過網路連接並協同工作,
對使用者來說就像是在使用單一資料庫一樣。
```

<br/>有以下特點：

{:class="table table-bordered"}
| 1. 資料分散性 | 資料實際上分散儲存在不同的實體位置,但在邏輯上是一個整體 |
| 2. 資料獨立性 | 每個節點可以獨立運作,擁有自己的資料管理系統 |
| 3. 持續可用性 | 某個節點故障,系統仍可繼續運作,提高了系統的可靠性 |

<br/>※補上集成圖片
<br/> <img src="/assets/image/Architecture/Database/Distributed/2025_03_29/XXX.png" alt=""  width="70%" height="70%" />
<br/><br/>


<h2>Step 2：資料庫分散式 - 用途</h2>
常見的使用情境如下：

{:class="table table-bordered"}
| 1. 跨國企業的系統 | 可以讓不同地區的分公司存取所需資料 |
| 2. 大型電商平台 | 需要在全球不同地區提供快速的資料存取服務 |
| 3. 社群媒體平台 | 需要處理大量的使用者資料並確保服務的可用性 |

<br/>但是資料庫分散存放會有以下問題要克服：

{:class="table table-bordered"}
| 1. 資料一致性 |
| 2. 同步機制 |
| 3. 網路延遲 |

<br/>本篇介紹 XA 協議，解決分散式資料庫 - 克服上述 3 個困難點
<br/><br/>

<h2>Step 3：資料庫分散式 - 四大核心維度</h2>
分散式資料庫通常從以下幾個主要維度進行觀察和分析，每個分散性資料庫架構都會依照這 4 個核心維度做評估考量


{:class="table table-bordered"}
| 1. 一致性協議角度 | 資料同步 & 速度 取捨方式; 資料一致性的層級，不可能同時存在 |
| 2. CAP理論角度 | 管理資料方式 ; 一致性(Consistency)、可用性(Availability)、分區容錯性(Partition tolerance)，3 取 2 做取捨 |
| 3. 數據分布角度 | 保存資料方式 ; 物理分布策略下，如何儲存、分割、複製和管理資料 |
| 4. 事務處理角度 | 實現方式 ; 如何確保分散式環境下的事務完整性和一致性 |

<br/> <img src="/assets/image/Architecture/Database/Distributed/2025_03_29/001.png" alt=""  width="70%" height="70%" />
<br/><br/>

<h2>Step 4：四大核心維度 - 一致性協議角度</h2>
這個角度主要關注的是「如何」實現資料一致性，以及在速度和一致性之間的取捨機制

<br/>1. 強一致性 (Paxos/Raft)：

{:class="table table-bordered"}
| Paxos | 由 Leslie Lamport 提出的分散式一致性算法 |
|       | 確保所有節點在某個值上達成一致 |
|       | 分為 Basic Paxos 和 Multi Paxos |
|       | 實現較為複雜，但提供強大的一致性保證 |
| Raft  | 為了解決 Paxos 實現複雜的問題而設計 |
|       | 將一致性問題分解為：領導人選舉、日誌複製、安全性 |
|       | 更容易理解和實現 |
|       | 被廣泛應用於如 etcd 等系統 |


<br/>2. 最終一致性 (Gossip)：

{:class="table table-bordered"}
| Gossip Protocol | 模仿病毒傳播的方式傳遞資訊 |
|          | 節點間隨機選擇對象交換資訊 |
|          | 最終所有節點都會收到資訊 |
|          | 適用於大規模分散式系統 |
| 補充特點  | 容忍網路延遲和分區 |
|          | 最終達到一致，但不保證即時一致 |
|          | 系統可用性高 |


<br/>3. 交易一致性 (XA/TCC)：

{:class="table table-bordered"}
| XA       | 是一個分散式事務處理標準 |
|          | 使用兩階段提交協議（2PC） |
|          | 適用於強一致性需求場景 |
| TCC (Try-Confirm-Cancel)  | 將事務分為 Try、Confirm、Cancel 三個階段 |
|          | 更靈活的事務處理方式 |
|          | 適用於微服務架構 |

<br/><br/>

<h2>Step 5：四大核心維度 - 一致性協議角度</h2>
這個理論影響了許多設計決策，例如在特定場景下選擇犧牲強一致性來換取更高的可用性

<br/>1. CP 型（一致性 + 分區容錯）：

{:class="table table-bordered"}
| CP 型（一致性 + 分區容錯） | 在網路分區時保證資料一致性 |
|                          | 可能暫時犧牲可用性 |
|                          | 適用於銀行等金融系統 |
|                          | EX: HBase、MongoDB (在主節點故障時) |

<br/>2.  AP 型（可用性 + 分區容錯） ：
| | 保證系統持續可用 |
|                          | 容忍資料暫時不一致 |
|                          | 適用於社交媒體等場景 |
|                          | EX: Cassandra、DynamoDB |
| CA 型（較少使用）          | 在單機或區域網路中使用 |
|                          | 確保所有節點在某個值上達成一致 |
|                          | 不考慮網路分區問題 |
|                          | 實際應用較少 |
|                          | EX: 傳統關聯式資料庫的主從架構 |

<br/><br/>

<h2>Step 6：四大核心維度 - 數據分布角度</h2>
分散式資料庫的核心元素、如何儲存、分割、複製和管理資料，同時也關係到資料的完整性、安全性和效能優化

<br/>1. ：

{:class="table table-bordered"}
| 分片 (Sharding) |           |                            |
|                 | 水平分片： | 依據key值將資料分散到不同節點 |
|                 |           | 提高系統容量和處理能力 |
|                 | 垂直分片： | 依據業務將不同表分散到不同節點 |
|                 |           | 提高特定業務的處理能力 |
| 複製 (Replication) |           |                            |
|                 | 主從複製： | 一個主節點多個從節點 |
|                 |           | 提高讀取性能和可用性 |
|                 | 多主複製： | 多個主節點可寫入 |
|                 |           | 提高寫入性能但增加複雜度 |
| 分片 (Sharding) | 混合 (Hybrid) |  結合分片和複製的優點 |
|                 |           | 根據業務需求靈活配置 |
|                 |           | 平衡性能和可用性 |

<br/><br/>

<h2>Step 7：四大核心維度 - 事務處理角度</h2>
這主要對應到「事務處理機制」和「一致性模型研究」中的具體實現方式

<br/>1. ：

{:class="table table-bordered"}
| ACID（完整事務特性） |  |
|       | Atomicity（原子性）：事務要麼全部完成，要麼全部失敗 |
|       | Consistency（一致性）：事務執行前後數據庫狀態一致 |
|       | Isolation（隔離性）：事務執行互不干擾 |
|       | Durability（持久性）：事務完成後永久生效 |
| BASE（最終一致性）  | Basically Available（基本可用）： 保證系統大部分時間可用 |
|       | Soft State（軟狀態）： 允許系統存在中間狀態 |
|       | Eventually Consistent（最終一致性）：數據最終達到一致狀態 |
| 混合  | 依據業務重要性選擇不同事務模型 |
|       | 重要交易使用 ACID |
|       | 一般操作使用 BASE |
|       | 在性能和一致性間取得平衡 |


<br/><br/>



<br/><br/>
<h1>第二部分：XA 協議概述</h1>
<h2>Step 1：</h2>
用自己的IDE 開啟，這裡是用 Visual Studio 2022 開啟 .sln檔案


<br/> <img src="/assets/image/Architecture/Database/Distributed/2025_03_29/001.png" alt=""  width="70%" height="70%" />
<br/><br/>




<br/><br/>
<h1>第三部分：XA 優缺點 &工作原理 </h1>
<h2>Step 1：如何使用</h2>
用自己的IDE 開啟，這裡是用 Visual Studio 2022 開啟 .sln檔案
<br/> <img src="/assets/image/MyProduct/2024_02_11/009.png" width="70%" height="70%" />
<br/><br/>




<br/><br/>
<h1>第四部分：XA 範例實作</h1>
<h2>Step 1：如何使用</h2>
用自己的IDE 開啟，這裡是用 Visual Studio 2022 開啟 .sln檔案
<br/> <img src="/assets/image/MyProduct/2024_02_11/009.png" width="70%" height="70%" />
<br/><br/>

``` Markdown

強一致性（Paxos/Raft）：
- 所有節點數據實時一致
- 寫入延遲較高
- 適合金融交易

最終一致性（Gossip）：
- 允許短暫的數據不一致
- 性能更好
- 適合社交媒體

交易一致性（XA/TCC）：
- 著重於事務完整性
- 支持跨庫事務
- 適合複雜業務流程
```