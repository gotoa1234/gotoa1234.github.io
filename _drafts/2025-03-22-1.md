---
layout: default_post
title: "0088. IIS Web網站如何實現 Session Sticky - .Net Core 與 .Net Framewrok 配置說明"
excerpt: "C# 學習筆記"
tags: 
- "Asp.NET Core"
- "Internet Information Service"
- "Windows"
---

<div class="summary">
<br/>解決問題：微軟的 .Net Core 與 .Net Framework 是各自如何在 Windows Server 上的 IIS 實現 Sesstion Sticky
<br/>基本介紹：本篇分為 3 部分。
<br/>第一部分：二者差異與介紹
<br/>第二部分：.Net Framework 於 IIS 實現方式
<br/>第三部分：.Net Core 於 IIS 實現方式

</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>

<br/><br/>

<h1>第一部分：二者差異與介紹</h1>

<h2>Step 1：差異 - 系統架構 & 效能 & 安全性</h2>

{:class="table table-bordered"}
|  | ASP.NET (.NET Framework) | ASP.NET Core |
| --- | --- | --- |
| 系統架構與平台 | 只能在 Windows 上運行    | 跨平台（Windows、Linux、macOS） |
|              | 依賴 IIS                | 獨立運行，不依賴 IIS |
|              | 強依賴於 System.Web.dll | 輕量級 |
| 效能與資源使用 | 記憶體占用較大 | 記憶體占用更少 |
|              | 預設引入功能多 | 按需要自行引入功能 |
|              |  啟動時間較長  |  啟動時間較短 |
| 安全性       | Forms Authentication | Identity 系統  |
|             | 手動配置 CORS | 更好的 CORS 支援 |
|             |              | 內建 CSRF 防護  |

<br/> 

<br/><br/>

<h2>Step 2：差異 - Session 配置 & 優劣</h2>
關於配置模式兩者有以下：

{:class="table table-bordered"}
| ASP.NET (.NET Framework) | ASP.NET Core |
| --- | --- |
| InProc      | 分散式 Session |
| StateServer | Redis 支援 |
| SQLServer 模式 | 更靈活的 Session 配置 |

<br/>因此優缺點延伸說明如下：

{:class="table table-bordered"}
| | ASP.NET (.NET Framework) | ASP.NET Core |
| --- | ---          | --- |
| 優點 | 開箱即用     | 跨平台 |
|     | 配置簡單     | 支援多種儲存方案 |
|     | 適合小型應用  | 可自定義實現 |
|     |             | 支援分散式 |
|     |             | 可上雲服務 |
|     |             |  |
| 缺點 | 擴展性差(IIS綁定)            |  |
|     | 只能在 Windows 上運行          |  |
|     | StateServer 模式效能較差       |  |
|     | 無法自定義儲存方式       |  |

<br/> Asp.net Core 大大提升了擴展性，不再侷限於 Windows 作業系統
<br/><br/>

<h2>Step 3：補充 - Forms Authentication 與 Identity 差別</h2>
 

| Forms Authentication (.NET Framework) | Identity (.NET Core) |
| --- | --- |
| 基本的身份驗證、角色管理 | 完整的用戶管理系統 |
| 僅提供驗證框架 | 支援第三方登入（Google、Facebook等） |

<br/> 表單驗證(Forms Authentication )實現的代碼

``` C#
// 登入驗證
public ActionResult Login(string username, string password)
{
    if (IsValid(username, password))
    {
		// 關鍵：自行設定表單 Cookie
        FormsAuthentication.SetAuthCookie(username, false);
        return RedirectToAction("Index", "Home");
    }
    return View();
}
```

<br/> Identity 實現的代碼 
<br/>在 **Program.cs**，初始化的地方依賴注入，整個 Asp.net Core Web 的 Cookie 都會自動實現

``` C#
// 配置 Identity
services.AddIdentity<ApplicationUser, IdentityRole>()
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddDefaultTokenProviders();

```


<br/>在 Controller.cs 層實作
<br/>在 **await _signInManager.PasswordSignInAsync()** 這個方法會進行 Cookie 的加密處理，並且自動封裝
<br>用戶識別碼、角色信息、安全戳記（Security Stamp）、聲明（Claims）等資料，不同於表單驗證，安全性提高並且部分功能自動化處理。


``` C#
public class AccountController : Controller
{
    private readonly SignInManager<ApplicationUser> _signInManager;
    
    public AccountController(
        SignInManager<ApplicationUser> signInManager
    {
        _signInManager = signInManager;
    }


    [HttpPost]
    [ValidateAntiForgeryToken]
    public async Task<IActionResult> Login(LoginViewModel model, string returnUrl = null)
    {
        ViewData["ReturnUrl"] = returnUrl;
        
        if (ModelState.IsValid)
        {
            // 關鍵： PasswordSignInAsync 會自動產生加密的 Cookie 
            var result = await _signInManager.PasswordSignInAsync(
                model.Email,
                model.Password,
                model.RememberMe,
                lockoutOnFailure: true);
        }

        return View(model);
    }
}

```


<br/><br/>




<h1>第二部分：.Net Framework 於 IIS 實現方式</h1>
<h2>Step 1：開啟 Bucket 權限</h2>
MinIO Web 首頁 -> Buckets -> 點擊 Access Policy 按鈕
<br/> <img src="/assets/image/LearnNote/2025_03_22/001.png" alt="" width="100%" height="100%" />
<br/><br/>







<h1>第三部分：.Net Core 於 IIS 實現方式</h1>
<h2>Step 1：直連的架構</h2>
如果是直連的情況，通常是沒問題 (第二部分：開放 MinIO 圖庫直連 的 Step 4.)
<br/> <img src="/assets/image/LearnNote/2025_03_22/001.png" alt="" width="100%" height="100%" />
<br/><br/>

