---
layout: default_post
title: "0099. Google 提供的機器人防護服務 - 實作導入 reCAPTCHA 到 C# 網站"
excerpt: "C# 學習筆記"
tags:
  - "Asp.NET Core"
  - "reCAPTCHA"
  - "Google Cloud Platform"
  - "Asp.NET Core"
  - "Asp.NET Core Web MVC"
  - "C#"
  - "Azure"
  - "Selenium"
  - "Web"
---

<div class="summary">
<br/>範例所需： 1. Visual Studio 2022 Asp.net Core
<br/>&emsp;&emsp;&emsp;&emsp;&emsp; 2. 開通 Google Cloud Platform 便於管理 reCAPTCHA 金鑰設定 (要有 Google 帳號啟用)
<br/>範例檔案：<a href="https://github.com/gotoa1234/MyBlogExample/tree/main/GoogleCloudStorageSupportS3APIExample">本篇範例代碼</a>
<br/>解決問題：如何啟用 Google 的 reCAPTCHA 並且導入 Asp.net Core C# Web ，達到防止機器人攻擊的效果，保護自己的網站
<br/>&emsp;&emsp;&emsp;&emsp;&emsp; 2. 2025/8月為止，說明當前 Google reCAPTCHA 的 3 種類型導入與用法
<br/>基本介紹：本篇分為五大部分。
<br/>第一部分：reCAPTCHA 介紹
<br/>第二部分：範例專案架構
<br/>第三部分：reCAPTCHA DEMO -「我不是機器人」核取方塊
<br/>第四部分：reCAPTCHA DEMO - 隱形 reCAPTCHA 標記
<br/>第五部分：reCAPTCHA DEMO - 以分數為依據 (v3)
</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>

<br/><br/>

<h1>第一部分：reCAPTCHA 介紹</h1>


<h2>Step 1： 介紹</h2>
reCAPTCHA 是一項免費服務，可以保護您的網站免受垃圾內容和濫用行為的侵擾。並採用先進的風險分析技術，分辨真人和機器人。
<BR/>以下是 Google 官方的<a href="https://cloud.google.com/recaptcha/docs/overview?hl=zh-tw">reCAPTCHA 總覽</a>：

```Markdown
reCAPTCHA 採用進階風險分析技術偵測詐欺行為，您可以透過 reCAPTCHA 保護網站或行動應用程式免受垃圾內容和濫用行為侵擾，並偵測其他類型的詐欺活動，例如憑證填充、帳戶盜用 (ATO) 和自動建立帳戶。
reCAPTCHA 提供更精細的分數、高風險事件的原因代碼、行動應用程式 SDK、密碼外洩偵測、多重驗證 (MFA)，以及調整網站專屬模型的功能，可保護企業業務。
```

<br/>目的就是**保護自己架設的網站、應用程式。**
<br/>本篇目標：針對自己的網站，分別說明 reCAPTCHA 3種驗證方式的用法與防護方式、C# DEMO 實作 (Checkbox , Invisible , Score)
<br/><img src="/assets/image/LearnNote/2025_09_20/000.png" alt="" width="70%" height="70%" />
<br/><br/>

<h2>Step2：可用方案 & 收費方式</h2>
可參考 Google 的<a href="https://cloud.google.com/recaptcha/docs/billing-information?hl=zh-tw#how-it-works">付費方式</a>分成 3 種方案類型
<br/>

{:class="tabletable-bordered"}
| reCAPTCHAEssentials | reCAPTCHAStandard | reCAPTCHAEnterprise |
| ---- | ------------------- | ----------------- |
| 最基礎版 | 標準版 | 企業版 |
| 未註冊 Google 帳戶 | 已註冊帳戶自動使用 | 花費更多錢升級 |
| 10,000 次免費評估 | 10,000 次免費評估 | 10,000 次免費評估 |
| 超過 10000 次停用 | 超過 10000 次可付 $8 最大可達 100,000 次 | 同 Standard ，超過 100,000 每次會收 0.001$ |
| | 超過 100,000 次自動升級到企業版 | |
| 基礎功能 | 標準功能 | 完整功能 |
| 不用繳費 | 月付 | 可以跟 Google 談多久付一次錢 |

<br/>
<br/><br/>

<h2>Step 3： 方案提供功能補充說明</h2>
在Google的<ahref="https://cloud.google.com/recaptcha/docs/compare-tiers?hl=zh-tw">reCAPTCHA參考指南</a>裡，列出3種方案類型功能說明：
<br/>這邊簡要補充各功能具體意義，詳細說明建議還是參考上面官方文件：

{:class="tabletable-bordered"}
| 功能 | 功能說明 |
| ---- | ---- |
| **視覺挑戰支援** | 指在驗證失敗或風險過高時，會展示圖片驗證挑戰（例如選擇交叉口圖片），以確保是真人操作。 |
| **網路應用程式防火牆防護** | 網站前面加一層安全防護網，會幫你擋掉惡意流量（像是爬蟲、DDoS 攻擊） |  
| **支援多重驗證 (MFA) (預先發布版)** | 除了密碼，還要多一個驗證步驟（EX: 簡訊 OTP 或 Email 驗證碼），降低帳號被盜的風險 |
| **密碼防護** | 使用者密碼有沒有出現在已知的資料外洩名單 |  
| **帳戶防護工具** | 若判定風險高，可要求額外驗證或暫時鎖定帳號 |
| **漫遊器分數精細程度** | 標準版分數等級只有（0.1, 0.3, 0.7, 0.9） ; 企業版可以更精細。便於使用者調整防禦策略 |
| **簡訊費用詐欺防護功能** | 防止惡意程式自動發送大量 SMS 驗證碼，導致你支付昂貴的簡訊費用 |
| **防範付款詐欺** | 配合分數與行為分析，提前阻擋可疑交易。 |
| **原因代碼** | 除了分數，還會告訴你「為什麼」分數低。 (EX: 部分 IP 來自高風險國家、裝置異常、或短時間大量操作) |  
| **使用 Annotation API 提供評估意見** | 可以回傳自己對該次驗證的評價（真人/機器人）給 Google，幫助它的 AI 變得更精準。 |
| **SLA** | Google 對你保證的服務可用性，例如「99.9% 正常運作時間」。 未達到，可以向 Google 進行索賠 |  
| **SLO** | SLA 是合約責任，SLO 是內部 KPI，達不到 Google 也不一定賠償。 |

<br/>
<br/><br/>

<h2>Step 4： 網站可啟用驗證方式與應用場景</h2>
以下是 3 種驗證方式與適用場景：

{:class="tabletable-bordered"}
| 項目 \ 驗證方式           | **v2 Checkbox**         | **Invisible reCAPTCHA (v2)**   | **v3（分數評估）**                   |
| ------------ | ----------------------- | ------------------------------ | ------------------------------ |
| **使用者互動**    | 需點「我不是機器人」核取方塊，有時出現圖片驗證 | 無需點擊核取框，隱形觸發驗證 (觸發才有操作)                | 完全無使用者操作                       |
| **UX 體驗**    | 介入性中：有視覺挑戰，減少衝擊         | 較無介入：對使用者更友善                   | 零中斷用戶體驗                        |
| **防機器人機制說明** | 使用行為分析 + 圖像驗證挑戰拦截機器人    | 背景行為風險評估，自動根據風險可能再顯示驗證畫面       | 背景分析使用者行為，回傳 0–1 分數，自訂門檻採取額外動作 |
| **適合應用場景**   | 表單、註冊、留言板的快速實作防護        | 需要平滑驗證流程的平台（如登入、提交）            | 大型網站、高流量平台，自己的網站需彈性策略防護             |

<br/>
<br/><br/>

<h1>第二部分：範例專案架構</h1>

<h2>Step 1：範例專案架構</h2>
打開<a href="https://github.com/gotoa1234/MyBlogExample/tree/main/GoogleCloudStorageSupportS3APIExample">本篇範例代碼</a>範例代碼</a>後，架構基本分成以下：

{:class="table table-bordered"}
| 1. 初始化配置  | ： | 依賴注入 IHttpClientFactory，善用微軟的 集中管理連線 + 自動回收 的方式，避免 TCP 資源浪費導致 Socket 用盡 | 
| 2. Model  | ： | 取得 Google reCAPTCHA 的 Response Json 資料，分別是 V2、V3  | 
| 3. 控制器  | ： | 分別實現 3 種 reCAPTCHA 驗證器 | 
| 4. Web 檢視器  | ： | 對應 3 種 reCAPTCHA 驗證器的檢視畫面 | 
| 5. 自動化測試專案  | ： | 實現自動化 Selenium 訪問我們架設好的 reCAPTCHA 驗證器，實證 reCAPTCHA 防護力 | 

<br/><img src="/assets/image/LearnNote/2025_09_20/011.png" alt="" width="70%" height="70%" />
<br/><br/>


<br/><br/>

<h1>第三部分：reCAPTCHA DEMO - 隱形 reCAPTCHA 標記</h1>

<h2>Step 1：註冊新 reCAPTCHA</h2>
登入<a href="https://developers.google.com/recaptcha/intro?hl=zh-tw">Google reCAPTCHA</a>網站，我們要註冊新的金鑰 -> 開始使用
<br/>※每個驗證器都需要獨立新增 reCAPTCHA ，因為 Google 會依照選擇驗證方式從而產生一對驗證器的金鑰。
<br/><img src="/assets/image/LearnNote/2025_09_20/000_1.png" alt="" width="70%" height="70%" />
<br/><br/>


<h2>Step 2：註冊新 reCAPTCHA - CheckBox</h2>
進入後到<a href="https://developers.google.com/recaptcha/intro?hl=zh-tw">註冊新頁面</a>，依序填寫如圖內容
<br/>這邊驗證類型選擇 **驗證問題(v2)** -> **「我不是機器人」核取方塊**
<br/>網域填寫：localhost ，這會用於開發者在 DEBUG 模式下可以驗證 reCAPTCHA 是否符合預期
<br/><img src="/assets/image/LearnNote/2025_09_20/001.png" alt="" width="70%" height="70%" />
<br/><br/>

<h2>Step 3：註冊新 reCAPTCHA - 取得網站金鑰、密鑰</h2>
接著會跳轉到設定完成，請將畫面上的 **網站金鑰**、**密鑰** 記錄下來

{:class="tabletable-bordered"}
| 功能 | 功能說明 |
| ---- | ---- |
| **網站金鑰** | 提供給前端的金鑰，即使明文被用戶知道也無訪 |
| **密鑰** | 存在於伺服器、應用程式中的密鑰，用來與網站金鑰配對，相符合時驗證器才生效 |  

<br/><img src="/assets/image/LearnNote/2025_09_20/002.png" alt="" width="70%" height="70%" />
<br/><br/>

<h2>Step 4：範例專案 - Razor 檢視器</h2>
開啟範例專案 -> Views/Home/CheckBoxV2.cshtml 檔案 -> 內容如下：
<br/>當用戶訪問時，必須要對 **我不是機器人打勾(CheckBox)** 

``` html
@{
    ViewData["Title"] = "reCAPTCHA V2 - 核取方塊，我不是機器人機制";
}

<h2>reCAPTCHA V2 - 核取方塊，我不是機器人機制 Demo</h2>

<form method="post" asp-action="CheckBoxV2Validate">
    <input type="text" name="Username" placeholder="輸入名稱" />

    <div class="g-recaptcha" data-sitekey="6Ld8zqErAAAAAOCngiA0B_rcMWjMdz3w3fjr8puv"></div>

    <button type="submit">送出</button>
</form>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>

@if (ViewBag.Message != null)
{
    <p>@ViewBag.Message</p>
}
```

<br/><br/>

<h2>Step 5：範例專案 - 後端控制器</h2>
開啟範例專案 -> Controller/Home/HomeController.CheckBoxV2.cs 檔案 -> 內容如下：
<br/>提供檢視、前端用戶點擊送出按鈕後，進行 reCAPTCHA 的 CheckBox V2 驗證
<br/>當 Success 時即表示驗證成功，此資訊會記錄於 Google 的分析統計中
<br/>請將 Step 3 獲得的網站金鑰填入 _checkBoxV2WebSiteKey 變數 & 密鑰填入 _checkBoxV2SecretKey 變數 

``` C#
public partial class HomeController : Controller
{
    // 1-1. 前端使用的網站金鑰
    private readonly string _checkBoxV2WebSiteKey = $@"";
    // 1-2. 後端使用的金鑰
    private readonly string _checkBoxV2SecretKey = $@"";

    /// <summary>
    /// 2. 檢視 View
    /// </summary>    
    [HttpGet]
    public IActionResult CheckBoxV2()
    {
        return View();
    }

    /// <summary>
    /// 3. 從前端獲得訪問 Token ，並反饋 reCAPTCHA CheckBox V2 驗證結果
    /// </summary>
    [HttpPost]
    public async Task<IActionResult> CheckBoxV2Validate(string Username)
    {
        // 3-1. 前端使用的 WebSite Key 
        var captchaResponse = Request.Form["g-recaptcha-response"];
        if (string.IsNullOrEmpty(captchaResponse))
        {
            ViewBag.Message = "請完成 reCAPTCHA - CheckBox V2 驗證";
            return View();
        }

        // 3-2. 將後端 + 前端使用的 key 送到 Google 的 reCAPTCHA 驗證
        var client = _httpClientFactory.CreateClient();
        var postData = new Dictionary<string, string> {
                           {"secret", _checkBoxV2SecretKey},
                           {"response", captchaResponse}
                       };

        // 3-3. 獲得響應結果 (CheckBox 與 Invisible 使用的 Json 格式相同)
        var response = await client.PostAsync("https://www.google.com/recaptcha/api/siteverify",
                                               new FormUrlEncodedContent(postData));
        var json = await response.Content.ReadAsStringAsync();
        var captchaResult = JsonSerializer.Deserialize<ReCaptchaResponse>(json);

        // 3-4.響應 - 並將結果放進 ViewBag 給用戶提示
        if (captchaResult.success)
        {
            ViewBag.Message = $"CheckBox V2 驗證成功，歡迎 {Username}！";
        }
        else
        {
            ViewBag.Message = "CheckBox V2 驗證失敗，請重試。";
        }

        // 4.返回頁面
        return View("CheckBoxV2");
    }
}

```

<br/><br/>

<h2>Step 6：驗證成果 - 啟動程式到首頁</h2>
啟動專案後，會來到程式首頁，選擇框選的地方跳轉到 DEMO 頁面

<br/><img src="/assets/image/LearnNote/2025_09_20/012.png" alt="" width="70%" height="70%" />
<br/><br/>


<h2>Step 7：驗證成果 - CheckBox V2 頁面</h2>
進入測試頁面 -> 進行打勾 (我不是機器人)
<br/><img src="/assets/image/LearnNote/2025_09_20/013.png" alt="" width="70%" height="70%" />
<br/><br/>


<h2>Step 8：驗證成果 - 判斷出真人</h2>
當我們用滑鼠點擊時，如果 reCAPTCHA 判斷從頁面載入，到打勾的過程中，演算出執行者是真人，會立刻出現打勾，表示正確
<br/><img src="/assets/image/LearnNote/2025_09_20/014.png" alt="" width="70%" height="70%" />
<br/>然後我們按下送出，可以獲得驗證成功的結果
<br/><img src="/assets/image/LearnNote/2025_09_20/015.png" alt="" width="70%" height="70%" />
<br/><br/>


<h2>Step 9：驗證成果 - 自動化工具訪問 CheckBox V2 驗證器 - 保持網站啟動</h2>
在本機對專案啟動，可以開啟 2 個 Visual Studio 或者直接下以下指令，啟動 localhost 的 Web

``` shell
dotnet reCAPTCHATbyGoogleExample.dll
```

<br/><img src="/assets/image/LearnNote/2025_09_20/016.png" alt="" width="70%" height="70%" />
<br/><br/>

<h2>Step 10：驗證成果 - 自動化工具訪問 CheckBox V2 驗證器 - 開啟工具</h2>
啟動該專案，是一個簡易的 Selenium 自動化工具
<br/><img src="/assets/image/LearnNote/2025_09_20/017.png" alt="" width="70%" height="70%" />
<br/>代碼如下：

``` C#
 using (IWebDriver driver = new ChromeDriver(options))
 {
     // 你的測試頁（必須含有 reCAPTCHA v2 Checkbox）
     driver.Navigate().GoToUrl("http://localhost:5000/Home/CheckBoxV2");

     // 等待頁面載入
     Thread.Sleep(2000);

     // 切換到 reCAPTCHA iframe
     IWebElement iframe = driver.FindElement(By.CssSelector("iframe[title='reCAPTCHA']"));
     driver.SwitchTo().Frame(iframe);

     // 方式 1：直接點擊（很容易被判定機器人）
     Console.WriteLine("直接 DOM Click reCAPTCHA...");
     IWebElement checkbox = driver.FindElement(By.Id("recaptcha-anchor"));
     checkbox.Click();

     Thread.Sleep(5000);

     // 回到主頁面
     driver.SwitchTo().DefaultContent();
     Thread.Sleep(2000);

     // 方式 2：模擬滑鼠移動
     driver.Navigate().Refresh();
     Thread.Sleep(2000);
     iframe = driver.FindElement(By.CssSelector("iframe[title='reCAPTCHA']"));
     driver.SwitchTo().Frame(iframe);

     Console.WriteLine("模擬滑鼠移動到 reCAPTCHA...");
     checkbox = driver.FindElement(By.Id("recaptcha-anchor"));

     Actions actions = new Actions(driver);
     actions.MoveToElement(checkbox)
            .Pause(TimeSpan.FromSeconds(1))
            .Click()
            .Perform();

     Thread.Sleep(10000); // 等待觀察
 }
```

<br/><br/>


<h2>Step 11：驗證成果 - CheckBox V2 驗證器 - 防護成功</h2>
自動化的過程，因為 Selenium 實現了瞬移，因此跳出驗證畫面，需要對圖片做驗證
<br/>成功的實現阻擋自動化機器人攻擊自家的網站。
<br/><img src="/assets/image/LearnNote/2025_09_20/018.png" alt="" width="70%" height="70%" />
<br/><br/>




<br/><br/>

<h1>第四部分：reCAPTCHA DEMO -「我不是機器人」核取方塊</h1>

<h2>Step 1：註冊新 reCAPTCHA</h2>
登入<a href="https://developers.google.com/recaptcha/intro?hl=zh-tw">Google reCAPTCHA</a>網站，我們要註冊新的金鑰 -> 開始使用
<br/>※每個驗證器都需要獨立新增 reCAPTCHA ，因為 Google 會依照選擇驗證方式從而產生一對驗證器的金鑰。
<br/><img src="/assets/image/LearnNote/2025_09_20/000_1.png" alt="" width="70%" height="70%" />
<br/><br/>


<br/><br/>

<h1>第五部分：reCAPTCHA DEMO - 以分數為依據 (v3)</h1>

<h2>Step 1：註冊新 reCAPTCHA</h2>
登入<a href="https://developers.google.com/recaptcha/intro?hl=zh-tw">Google reCAPTCHA</a>網站，我們要註冊新的金鑰 -> 開始使用
<br/>※每個驗證器都需要獨立新增 reCAPTCHA ，因為 Google 會依照選擇驗證方式從而產生一對驗證器的金鑰。
<br/><img src="/assets/image/LearnNote/2025_09_20/000_1.png" alt="" width="70%" height="70%" />
<br/><br/>


<a href="https://www.google.com/recaptcha/">管理 reCAPTCHA</a>
