---
layout: default_post
title: "0073. RabbitMQ 生產者-消費者模式下 & 如何使用 RabbitMQ 內建負載平衡進行推送 "
excerpt: "C# 學習筆記"
tags: RabbitMQ .netCore Web
---

<div class="summary">
<br/>注意事項2：此篇範例是將套件安裝在同一個Server下
<br/>應用所需：1. 已架設好 RabbitMQ 主機
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. Visual Studio 2022 Asp.net Core
<br/>解決問題：架設 Ubuntu 主機上的 GrayLog Server 收集Log
<br/>相關參考：<a href="https://gotoa1234.github.io/2022/05/18/1.html">0029. Windows作業系統架設 RabbitMQ 的流程</a>
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;<a href="https://gotoa1234.github.io/2022/05/22/1.html">0030. RabbitMQ生產者與消費者範例說明</a>
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;<a href="https://gotoa1234.github.io/2024/06/16/1.html">0068. SignalR 橫向擴展部署 Server - RabbitMQ Backplane 解決方案</a>
<br/>基本介紹：本篇分為四大部分。
<br/>第一部分：RabbitMQ 負載平衡原理
<br/>第二部分：Web專案架構
<br/>第三部分：代碼解析
<br/>第四部分：DEMO 驗證成果

</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>


<br/><br/>
<h1>第一部分：RabbitMQ 負載平衡原理</h1>

<h2>Step 1：解決問題</h2>
在實務工作中，可能會有像下單系統，我們準備多個伺服器，讓用戶可以下訂單，但是只需要一伺服器做處理。
<br/>如果這時有多個伺服器同時執行這個訂單就會發生重複生成訂單的問題，這時就可以借助 RabbitMQ 當負載平衡
<br/>每個[伺服器]只要負責建立資料，再提交給 RabbitMQ 再讓 RabbitMQ 發送給比較悠閒的[伺服器]進行處理。
<br/> <img src="/assets/image/LearnNote/2024_09_28/001.png" width="70%" height="70%" />
<br/><br/>

<h2>Step 2：確保消息的穩定性與可靠性</h2>
假設我們有 2 個伺服器(代碼完全相同，並且都可以負責建訂單，處理訂單)，建立訂單的速度在實務上很快的
<br/>1. 每個伺服器只要建立訂單(生產者)後，立刻往 RabbitMQ 推送
<br/>2. MQ 機器收到後，會負責分派工作給某個伺服器處理，並且成功完成的伺服器必須做 ACK 響應後，此工作才會從 MQ 完成
<br/>※ Rabbit MQ 的負載平衡機制下，即使 MQ 當機、伺服器掛掉，只要重啟後，仍會持續將未完成的定單派送到訂閱的伺服器進行消費。
<br/> <img src="/assets/image/LearnNote/2024_09_28/002.png" width="70%" height="70%" />
<br/><br/>

<h2>Step 3：優點、缺點</h2>
使用此機制的優點如下：

{:class="table table-bordered"}
| 精確的路由控制 | ： | Rabbit MQ 的 Direct 交換器會根據消息的 routing key 來進行精確路由，也就是可以精確的指定使用隊列，不衝突 | 
| 靈活的負載分配 | ： | Rabbit MQ 有內建的功能，可以分配交換器任務的優先級，並且可以下定自己的策略 | 
| 簡單且易於配置 | ： | Direct 交換器的設置十分容易，只需配置 routing key 即可 | 
| 不遺失消息與具可靠性 | ： | Direct 交換器會確保消息只被發送到匹配的隊列，這能避免消息被錯誤地路由到不相關的消費者，並且未響應完成的任務，會常駐於 Queue 中 | 

<br/>相對的有以下缺點：

{:class="table table-bordered"}
| 額外的成本 | ： | Rabbit MQ Server 是額外的服務，需要占用記憶體、硬碟空間 | 
| 單點故障風險 | ： | 如果某一特定 routing key 對應的隊列或消費者出現故障，該 routing key 的消息將無法被處理，這可能會導致該類型的消息積壓，嚴重 | 
|             | ： | 會影響整個主機無法啟動 |
| 仍有消息分佈不均的風險 | ： | 伺服器如果規格不統一，或者機器異常，仍會有消息分配不均的問題，MQ 的工作本質不是維護其他伺服器是否正常 | 
|                     | ： | 無法工作的伺服器，仍會被不均的跳過。 |
| 學習成本 | ： | 使用 Rabbit MQ 仍需要理解此套件的用法 |

<br/> <img src="/assets/image/LearnNote/2024_09_28/002.png" width="70%" height="70%" />
<br/><br/>


<br/><br/>
<h1>第二部分：Web專案架構</h1>

<h2>Step 1：前言</h2>
<br/> <img src="/assets/image/LearnNote/2024_09_28/001.png" width="70%" height="70%" />
<br/><br/>


<h2>Step 2：範例專案架構</h2>
<br/>

{:class="table table-bordered"}
| 1. RabbitMQ | ： | 實現生產者、消費者與共用的工廠方法，提供任何專案進行訂閱 | 
| 2. 假資料庫  | ： | 為了方便說明，利用 Singleton 保存記憶體的資料，偽裝成資料庫，並提供訂單格式 | 
| 3. RabbitMQ 訂閱  | ： | 每個專案如果有實現生產者，需要對 RabbitMQ 做訂閱，並且實現自己的消費者行為  | 
| 4. Service  | ： | 這邊實現查詢、下訂單、處理訂單，模擬帳戶訂單流程 | 
| 5. Web控制器  | ： | 提供 Html 畫面取資料、進行下訂單的 API 接口 | 
| 6. Html 畫面  | ： | 與用戶互動，提供可視化的介面，可以知道處理訂單的消費者是哪一台機器 | 
| 7. 初始化配置  | ： | RabbitMQ、Service 等所需的依賴注入  | 


<br/> <img src="/assets/image/LearnNote/2024_09_28/000.png" width="50%" height="50%" />
<br/>



<br/><br/>
<h1>第三部分：代碼解析</h1>

<h2>Step 1：添加 MongoDB 軟件</h2>
安裝 MongoDB 需將此軟體添加到 Ubuntu 的列表中，版本 6.0
<br/>Ubuntu 輸入以下：

``` bash
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
```

<br/> <img src="/assets/image/LearnNote/2024_09_28/001.png" width="70%" height="70%" />
<br/><br/>



<h1>第四部分：DEMO 驗證成果</h1>

<h2>Step 1：添加 MongoDB 軟件</h2>
安裝 MongoDB 需將此軟體添加到 Ubuntu 的列表中，版本 6.0
<br/>Ubuntu 輸入以下：

``` bash
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
```

<br/> <img src="/assets/image/LearnNote/2024_09_28/001.png" width="70%" height="70%" />
<br/><br/>
