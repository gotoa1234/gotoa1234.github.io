---
layout: default_post
title:  "0085. 部署期間用戶會話不遺失：Redis 共用 Session 儲存解決方案"
excerpt: "C# 學習筆記"
tags: 
- "C#"
- "Nginx"
- "Redis"
- "Asp.net Core Web MVC"
- "Session"
---
<div class="summary">
<br/>應用所需：1. Visual Studio 2022 以上，支援 .net Core 8.0 以上
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;2. Nginx Server 需配置 Session Sticky
<br/>&emsp;&emsp;&emsp;&emsp;&emsp;3. Redis 
<br/>解決問題：一個網站使用 Session 實現使用者登入機制，但在部署站台時，由於 Session 遺失，使用者會被強制登出。透過使用 Redis 來保存 Session，可以有效解決這個問題。
<br/>範例檔案：<a href="https://github.com/gotoa1234/MyBlogExample/tree/main/ZeroDowntimeDeploymentForDockerWebsiteExample">Session 登入代碼</a>
<br/>基本介紹：本篇分為四大部分。
<br/>第一部分：問題重現過程
<br/>第二部分：解決方案
<br/>第三部分：實現過程
<br/>第四部分：Demo 驗證成果

</div>

<div class="title">
    <br/><hr class="titleinner">
	<span></span>
	<hr class="titleinner"><br/>
</div>

<br/><br/>
<h1>第一部分：問題重現過程</h1>

<h2>Step 1：差異性、優缺點</h2>
以下是整理的列表，並且加入 RabbitMQ 進行比較： 
<br/>

{:class="table table-bordered"}
| 特性 | Pub/Sub | List | RabbitMQ |
| --- | ------ | ---- | ------ |
| 即時性 | 高，即時推送給所有訂閱者 | 較低，消費者需主動拉取消息 | 高，支持即時消息推送 |
| 持久化 | 不支持，消息未消費即丟失 | 支持，未消費的消息保留在隊列中 | 支持，支持消息持久化到磁盤 | 
| 多消費者支持 | 支持，所有訂閱者接收相同消息 | 不支持，每條消息只能被一個消費者處理 | 支持，可配置為多消費模式或單消費模式 |
| 消息順序性 | 不保證 | 保證 FIFO | 	支持 FIFO，且可以配置為嚴格順序
| 錯誤處理 |  不支持重試，消息可能丟失 | 消息可重新處理 | 支持，死信隊列和重試機制
| 消息篩選 | 不支持，所有訂閱者收到相同消息 | 不支持 | 支持通過交換機和綁定鍵過濾消息
| 消息吞吐量 | 高 | 高 | 高，且支持多種優化機制
| 消息確認 | 不支持，消息推送即完成 | 不需要 | 支持，確認後消息才認為成功處理
| 適用場景 | 廣播、通知 | 工作隊列、任務調度 | 複雜消息隊列架構，如分布式系統、事件驅動架構

<br/>由以上可知，在選擇時任務時，若小型專案，可以選用 Redis 處理生產者與消費者模式，如果資料沒有保存可靠性，可以只用 Pub/Sub 模式。
<br/>


<br/><br/>
<h1>第二部分：解決方案</h1>

<h2>Step 1：範例專案架構</h2>
打開範例專案後 <a href="https://github.com/gotoa1234/MyBlogExample/tree/main/RedisProducerAndComsumerForPubAndSubExample">Redis Pub/Sub 生產者消費者代碼</a>，架構基本分成以下：

{:class="table table-bordered"}
| 1. Service | ： | 實現生產者、消費者的 Pub/Sub 方法 | 
| 2. 背景服務  | ： | 訂閱事件，實現消費者，處理 SubScribe Publish 到消費者的工作 | 
| 3. Web控制器  | ： | 提供 Html 畫面、生產者資料 API 接口 | 
| 4. Html 畫面   | ： | 畫面，呼叫生產者進行 Publish 工作 | 
| 5. 初始化配置  | ： | Redis、Pub/Sub、背景服務所需的依賴注入  | 


<br/> <img src="/assets/image/LearnNote/2025_02_22/001.png" alt="" width="50%" height="50%" />
<br/>


<br/><br/>
<h1>第三部分：實現過程</h1>

<h2>Step 1：範例專案架構</h2>
打開範例專案後 <a href="https://github.com/gotoa1234/MyBlogExample/tree/main/RedisProducerAndComsumerForPubAndSubExample">Redis Pub/Sub 生產者消費者代碼</a>，架構基本分成以下：

<br/> <img src="/assets/image/LearnNote/2025_02_22/001.png" alt="" width="50%" height="50%" />
<br/>




<br/><br/>
<h1>第四部分：Demo 驗證成果</h1>

<h2>Step 1：範例專案架構</h2>
打開範例專案後 <a href="https://github.com/gotoa1234/MyBlogExample/tree/main/RedisProducerAndComsumerForPubAndSubExample">Redis Pub/Sub 生產者消費者代碼</a>，架構基本分成以下：

<br/> <img src="/assets/image/LearnNote/2025_02_22/001.png" alt="" width="50%" height="50%" />
<br/>
