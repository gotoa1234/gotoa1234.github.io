<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Busan 2025</title>
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Busan 2025">
    <!-- App Icon -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/south-korea.png">

    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            overscroll-behavior-y: none;
            padding-top: env(safe-area-inset-top);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        /* Ambient Background */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1; background: #f1f5f9; overflow: hidden;
        }
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6;
            animation: float 20s infinite ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: #a5f3fc; top: -50px; left: -50px; }
        .orb-2 { width: 400px; height: 400px; background: #bae6fd; bottom: -100px; right: -100px; animation-delay: -5s; }
        .orb-3 { width: 200px; height: 200px; background: #e0f2fe; top: 40%; left: 30%; animation-delay: -10s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }

        /* Drag and Drop Styles */
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; }
        .sortable-drag { cursor: grabbing; }
        
        .hidden { display: none !important; }
        
        header { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-cyan-200 selection:text-cyan-900">

    <div class="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <div id="app" class="relative min-h-screen pb-24">

        <!-- Header -->
        <header class="fixed top-0 inset-x-0 z-50 glass shadow-sm transition-all duration-300">
            <div class="max-w-md mx-auto px-5 py-3 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black tracking-tight text-slate-900 flex items-center gap-2">
                        <i class="fa-solid fa-plane-departure text-cyan-600"></i>
                        Busan <span class="text-cyan-600">2025</span>
                    </h1>
                    <p class="text-[10px] font-medium text-slate-500 tracking-wider uppercase">Flagship Travel Assistant</p>
                </div>

                <div class="flex items-center gap-2">
                    <!-- Edit Mode Toggle -->
                    <button id="toggle-edit-btn" onclick="toggleEditMode()" 
                       class="w-8 h-8 rounded-full border flex items-center justify-center shadow-sm transition-all active:scale-95 bg-white/50 hover:bg-white text-slate-600 border-slate-200">
                        <i class="fa-solid fa-pen" id="edit-icon"></i>
                    </button>

                    <!-- Papago Translate -->
                    <a id="papago-link" href="papago://" 
                       class="w-8 h-8 rounded-full bg-white/50 hover:bg-white border border-slate-200 flex items-center justify-center text-slate-600 shadow-sm transition-all active:scale-95">
                        <i class="fa-solid fa-language text-sm"></i>
                    </a>
                    
                    <!-- Weather -->
                    <div id="weather-display" class="hidden flex items-center gap-1.5 bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-2 py-1 rounded-lg shadow-md shadow-cyan-500/20">
                        <span id="weather-icon" class="text-base">‚òÄÔ∏è</span>
                        <span id="weather-temp" class="font-bold text-xs">--¬∞C</span>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="max-w-md mx-auto px-4 pb-3 pt-1">
                <div id="tabs-container" class="flex space-x-2 overflow-x-auto hide-scrollbar pb-1">
                    <!-- Tabs injected by JS -->
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="max-w-md mx-auto px-5 pt-36 space-y-8">
            <!-- Timeline List Container -->
            <div id="timeline-list" class="min-h-[300px]">
                <!-- Items injected by JS -->
            </div>
            
            <!-- Add Button (Visible only in Edit Mode) -->
            <div id="add-btn-container" class="hidden pl-6 pb-8">
                <button onclick="openAddModal()" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl flex items-center justify-center text-slate-400 font-bold gap-2 hover:border-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all active:scale-95">
                    <i class="fa-solid fa-plus"></i>
                    Êñ∞Â¢ûÊôØÈªû
                </button>
            </div>
            
            <div class="h-12 flex items-center justify-center text-slate-300 text-xs">
                Made with <i class="fa-solid fa-heart mx-1 text-red-300"></i> for Busan
            </div>
        </main>

        <!-- FAB (Hidden in Edit Mode) -->
        <div id="fab-container" class="fixed bottom-6 right-5 flex flex-col gap-3 z-40 transition-transform duration-300">
            <button onclick="exploreNearby('food')" 
                class="w-12 h-12 rounded-full bg-amber-500 text-white shadow-lg shadow-amber-500/40 flex items-center justify-center hover:scale-110 active:scale-95 transition-all">
                <i class="fa-solid fa-utensils"></i>
            </button>
            <button onclick="exploreNearby('spot')" 
                class="w-14 h-14 rounded-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-xl shadow-cyan-500/40 flex items-center justify-center hover:scale-110 active:scale-95 transition-all">
                <i class="fa-solid fa-compass text-2xl"></i>
            </button>
        </div>

        <!-- Edit/Add Modal -->
        <div id="modal-overlay" class="hidden fixed inset-0 z-[100] flex items-end sm:items-center justify-center sm:p-5">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-sm p-6 relative shadow-2xl space-y-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-2">
                    <h3 id="modal-title" class="text-lg font-bold text-slate-800">Êñ∞Â¢ûÊôØÈªû</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Category -->
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="cat-spot" onclick="setCategory('spot')" 
                            class="py-2 rounded-xl text-sm font-bold border transition-all bg-cyan-500 text-white border-cyan-500 shadow-md">
                            <i class="fa-solid fa-location-dot mr-1"></i> ÊôØÈªû
                        </button>
                        <button type="button" id="cat-food" onclick="setCategory('food')" 
                            class="py-2 rounded-xl text-sm font-bold border transition-all bg-white text-slate-500 border-slate-200">
                            <i class="fa-solid fa-utensils mr-1"></i> ÁæéÈ£ü
                        </button>
                    </div>

                    <!-- Basic Info -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1">ÊôÇÈñì</label>
                            <input id="input-time" type="time" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1">ÂêçÁ®±</label>
                            <input id="input-name" type="text" placeholder="‰æãÂ¶Ç: Êµ∑Èõ≤Âè∞" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-500">
                        </div>
                    </div>

                    <!-- Korean Info (Search Helper) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-slate-500">ÈüìÊñáÂêçÁ®± (Áî®ÊñºÂú∞ÂúñÊêúÂ∞ã)</label>
                            <a id="naver-search-link" href="#" target="_blank" class="text-[10px] text-blue-500 font-bold hover:underline">
                                <i class="fa-solid fa-magnifying-glass mr-1"></i>Âú® Naver Map ÊêúÂ∞ã
                            </a>
                        </div>
                        <input id="input-koreanName" type="text" placeholder="Ë§áË£ΩÈüìÊñáË≤º‰∏ä" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-500 font-sans">
                    </div>

                    <!-- Address -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Âú∞ÂùÄ</label>
                        <input id="input-address" type="text" placeholder="Ë≤º‰∏äÂú∞ÂùÄ" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-cyan-500">
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Á≠ÜË®ò / ÁáüÊ•≠ÊôÇÈñì</label>
                        <input id="input-note" type="text" placeholder="ÂÇôË®ª" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-cyan-500 mb-2">
                        <input id="input-hours" type="text" placeholder="ÁáüÊ•≠ÊôÇÈñì" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-cyan-500">
                    </div>
                </div>
                
                <button onclick="saveItem()" class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold text-sm shadow-lg hover:bg-slate-900 active:scale-95 transition-all">
                    ÂÑ≤Â≠òËÆäÊõ¥
                </button>
                <div class="h-4 sm:h-0"></div>
            </div>
        </div>
        
        <!-- Toast -->
        <div id="toast" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-2xl shadow-2xl z-[120] flex items-center gap-3 transition-opacity duration-300">
            <i class="fa-solid fa-circle-check text-green-400"></i>
            <span id="toast-message" class="font-medium text-sm">Êìç‰ΩúÊàêÂäü</span>
        </div>

    </div>

    <script>
        // --- State Management ---
        const days = [
            { name: "Day 1 (ÈÄ±Âõõ)", id: 1 },
            { name: "Day 2 (ÈÄ±‰∫î)", id: 2 },
            { name: "Day 3 (ÈÄ±ÂÖ≠)", id: 3 },
            { name: "Day 4 (ÈÄ±Êó•)", id: 4 }
        ];

        const rawData = {
            0: {
                items: [
                    { time: "08:30", category: "spot", name: "Spa Land", koreanName: "Ïä§ÌååÎûúÎìú ÏÑºÌÖÄÏãúÌã∞", address: "Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄÍµ¨ ÏÑºÌÖÄÎÇ®ÎåÄÎ°ú 35", note: "Ë£úÁú†„ÄÅÁîúÁ±≥Èú≤", hours: "09:00 - 22:00", lat: 35.1689, lng: 129.1319 },
                    { time: "13:00", category: "food", name: "Ê∞¥ÈÇäÊúÄÈ´òË±¨ËÇâÊπØÈ£Ø", koreanName: "ÏàòÎ≥ÄÏµúÍ≥†ÎèºÏßÄÍµ≠Î∞• ÏÑºÌÖÄÏ†ê", address: "Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄÍµ¨ ÏÑºÌÖÄ3Î°ú 26", note: "Ë®òÂæóÂä†Ëù¶ÈÜ¨ÊèêÂë≥", hours: "24Â∞èÊôÇÁáüÊ•≠", lat: 35.1685, lng: 129.1300 },
                    { time: "14:30", category: "spot", name: "Êñ∞‰∏ñÁïåÁôæË≤® Centum City", koreanName: "Ïã†ÏÑ∏Í≥ÑÎ∞±ÌôîÏ†ê ÏÑºÌÖÄÏãúÌã∞", address: "Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄÍµ¨ ÏÑºÌÖÄÎÇ®ÎåÄÎ°ú 35", note: "ÈÄõË°ó", hours: "10:30 - 20:00", lat: 35.1691, lng: 129.1296 },
                    { time: "16:30", category: "spot", name: "Solaria Nishitetsu Hotel", koreanName: "ÏÜîÎùºÎ¶¨ÏïÑ ÎãàÏãúÏ≤† Ìò∏ÌÖî Î∂ÄÏÇ∞", address: "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ ÏÑúÎ©¥Î°ú 20", note: "Check-in", hours: "Check-in: 15:00", lat: 35.1528, lng: 129.0560 },
                    { time: "18:30", category: "food", name: "ÈüìÁâõÁÉ§ËÇâ", koreanName: "Ïö∞ÏÇ¨Îûë", address: "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ Ï§ëÏïôÎåÄÎ°ú691Î≤àÍ∏∏ 52", note: "‰∫´ÂèóÈüìÁâõ", hours: "11:00 - 23:00", lat: 35.1517, lng: 129.0592 },
                    { time: "20:30", category: "spot", name: "Olive Young", koreanName: "Ïò¨Î¶¨Î∏åÏòÅ ÏÑúÎ©¥ÌÉÄÏö¥Ï†ê", address: "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ ÏÑúÎ©¥Î°ú 24", note: "Êé°Ë≤∑‰øùÈ§äÂìÅ", hours: "10:00 - 22:30", lat: 35.1542, lng: 129.0573 }
                ]
            },
            1: {
                items: [
                    { time: "10:30", category: "spot", name: "Skyline Luge Busan", koreanName: "Ïä§Ïπ¥Ïù¥ÎùºÏù∏Î£®ÏßÄ Î∂ÄÏÇ∞", address: "Î∂ÄÏÇ∞ Í∏∞Ïû•Íµ∞ Í∏∞Ïû•Ïùç ÏãúÎûëÎ¶¨ ÏÇ∞60-1", note: "Áé©ÊªëÂù°Ëªä", hours: "10:00 - 19:00", lat: 35.1956, lng: 129.2132 },
                    { time: "13:00", category: "food", name: "101Áï™Âú∞ ÂçóÂ±±ÁÇ∏Ë±¨Êéí", koreanName: "101Î≤àÏßÄ ÎÇ®ÏÇ∞ÎèàÍπåÏä§ Î°ØÎç∞Î™∞ÎèôÎ∂ÄÏÇ∞Ï†ê", address: "Î∂ÄÏÇ∞ Í∏∞Ïû•Íµ∞ Í∏∞Ïû•Ïùç Í∏∞Ïû•Ìï¥ÏïàÎ°ú 147", note: "Ê®ÇÂ§©Outlet 3F (ÁÑ°Êµ∑ÈÆÆ)", hours: "10:30 - 21:00", lat: 35.1915, lng: 129.2120 },
                    { time: "14:30", category: "food", name: "Diart Coffee", koreanName: "ÎîîÏïÑÌä∏Ïª§Ìîº", address: "Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄÍµ¨ Ï≤≠ÏÇ¨Ìè¨Î°ú 128Î≤àÍ∏∏ 12", note: "ÂøÖÂêÉ Kaymak", hours: "10:30 - 21:30 (ÈÄ±‰∫å‰ºë)", lat: 35.1593, lng: 129.1932 },
                    { time: "16:30", category: "spot", name: "Êµ∑Èõ≤Âè∞Êµ∑Ê∞¥Êµ¥Â†¥", koreanName: "Ìï¥Ïö¥ÎåÄÌï¥ÏàòÏöïÏû•", address: "Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄÍµ¨ Ïö∞Îèô", note: "Êï£Ê≠•ÁúãÂ§ïÈôΩ", hours: "ÂÖ®Â§©ÈñãÊîæ", lat: 35.1587, lng: 129.1604 },
                    { time: "19:00", category: "food", name: "83ÁÉ§ËÇâ", koreanName: "83Ìï¥Ïπò", address: "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ ÏÑúÎ©¥Î°ú 68Î≤àÍ∏∏ 16", note: "‰∫∫Ê∞£‰ª£ÁÉ§ (ÂøÖÊéíÈöä)", hours: "16:00 - 01:00", lat: 35.1545, lng: 129.0567 },
                    { time: "21:30", category: "food", name: "Out Dark ÁÇ∏Èõû", koreanName: "ÏïÑÏõÉÎã≠ ÏÑúÎ©¥Ï†ê", address: "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ ÎèôÏ≤úÎ°ú85Î≤àÍ∏∏ 37", note: "ÂÆµÂ§úÈÖçÂï§ÈÖí", hours: "16:00 - 02:00", lat: 35.1553, lng: 129.0602 }
                ]
            },
            2: {
                items: [
                    { time: "09:30", category: "spot", name: "ÁîòÂ∑ùÊ¥ûÊñáÂåñÊùë", koreanName: "Í∞êÏ≤úÎ¨∏ÌôîÎßàÏùÑ", address: "Î∂ÄÏÇ∞ ÏÇ¨ÌïòÍµ¨ Í∞êÎÇ¥2Î°ú 203", note: "Ë∑üÂ∞èÁéãÂ≠êÊãçÁÖß", hours: "09:00 - 18:00 (Âª∫Ë≠∞)", lat: 35.0975, lng: 129.0106 },
                    { time: "12:30", category: "food", name: "Âá°ËÉéÊâãÂ∑•ÁÇ∏ÈÜ¨È∫µ", koreanName: "Î≤îÌÉúÏòõÎÇ†ÏÜêÏßúÏû•", address: "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ Í∞ÄÏïºÎåÄÎ°ú784Î≤àÍ∏∏ 15", note: "Á≥ñÈÜãËÇâ+ÁÇ∏ÈÜ¨È∫µ", hours: "11:30 - 22:00", lat: 35.1558, lng: 129.0545 },
                    { time: "14:00", category: "spot", name: "NCÁôæË≤® Ë•øÈù¢Â∫ó", koreanName: "NCÎ∞±ÌôîÏ†ê ÏÑúÎ©¥Ï†ê", address: "Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ ÎèôÏ≤úÎ°ú 92", note: "ÈÄõË°ó", hours: "10:30 - 21:00", lat: 35.1573, lng: 129.0628 },
                    { time: "20:00", category: "spot", name: "Âª£ÂÆâÈáåÊµ∑Ê∞¥Êµ¥Â†¥", koreanName: "Í¥ëÏïàÎ¶¨Ìï¥ÏàòÏöïÏû•", address: "Î∂ÄÏÇ∞ ÏàòÏòÅÍµ¨ Í¥ëÏïàÌï¥Î≥ÄÎ°ú 219", note: "Â§úÊôØ", hours: "ÂÖ®Â§©ÈñãÊîæ", lat: 35.1532, lng: 129.1187 }
                ]
            },
            3: {
                items: [
                    { time: "10:30", category: "spot", name: "ÁôΩÈö™ÁÅòÊñáÂåñÊùë", koreanName: "Ìù∞Ïó¨Ïö∏Î¨∏ÌôîÎßàÏùÑ", address: "Î∂ÄÏÇ∞ ÏòÅÎèÑÍµ¨ ÏòÅÏÑ†Îèô4Í∞Ä 1044-6", note: "Êµ∑ÊôØ Aether Cafe", hours: "ÂÖ®Â§©ÈñãÊîæ (Â∫óËàñ‰∏ç‰∏Ä)", lat: 35.0783, lng: 129.0435 },
                    { time: "13:00", category: "food", name: "ÈáúÂ±±Ë±¨ËÖ≥", koreanName: "Î∂ÄÏÇ∞Ï°±Î∞ú", address: "Î∂ÄÏÇ∞ Ï§ëÍµ¨ Í¥ëÎ≥µÎ°ú 17-1", note: "ÂÜ∑ËèúË±¨ËÖ≥ (ÁÑ°Êµ∑ÈÆÆ)", hours: "10:00 - 00:30", lat: 35.0995, lng: 129.0267 },
                    { time: "14:30", category: "spot", name: "BIFF Âª£Â†¥", koreanName: "BIFF Í¥ëÏû•", address: "Î∂ÄÏÇ∞ Ï§ëÍµ¨ Íµ¨ÎçïÎ°ú 58-1", note: "Â†ÖÊûúÈªëÁ≥ñÈ§Ö", hours: "ÂÖ®Â§©ÈñãÊîæ", lat: 35.0987, lng: 129.0270 },
                    { time: "16:30", category: "spot", name: "Ê®ÇÂ§©Ë∂ÖÂ∏Ç ÂÖâÂæ©Â∫ó", koreanName: "Î°ØÎç∞ÎßàÌä∏ Í¥ëÎ≥µÏ†ê", address: "Î∂ÄÏÇ∞ Ï§ëÍµ¨ Ï§ëÏïôÎåÄÎ°ú 2", note: "‰º¥ÊâãÁ¶Æ", hours: "10:30 - 23:00 (ÊØèÊúàÁ¨¨2/4ÈÄ±Êó•‰ºë)", lat: 35.0967, lng: 129.0345 },
                    { time: "18:30", category: "food", name: "ÂçóÊµ¶ËîòÈõûÊπØ", koreanName: "ÎÇ®Ìè¨ÏÇºÍ≥ÑÌÉï", address: "Î∂ÄÏÇ∞ Ï§ëÍµ¨ ÎÇ®Ìè¨Í∏∏ 16", note: "ÊöñËÉÉ‰∏äÈ£õÊ©ü", hours: "10:30 - 21:00", lat: 35.0984, lng: 129.0310 }
                ]
            }
        };

        // Current App State
        let state = {
            currentDay: 0,
            isEditing: false,
            tripData: {},
            weather: null,
            editIndex: -1, // -1 means adding new
            editForm: { category: 'spot', name: '', koreanName: '', time: '', address: '', note: '', hours: '' }
        };

        let sortableInstance = null;

        // --- Initialization ---

        function ensureIds(data) {
            if (!data || typeof data !== 'object') return null;
            try {
                Object.values(data).forEach(day => {
                    if (day && day.items && Array.isArray(day.items)) {
                        day.items.forEach((item, idx) => {
                            if (!item.id) {
                                item.id = 'id_' + Date.now() + '_' + Math.floor(Math.random() * 1000) + '_' + idx;
                            }
                        });
                    }
                });
                return data;
            } catch (e) { return null; }
        }

        function loadData() {
            let data = ensureIds(rawData);
            try {
                const saved = localStorage.getItem('busanTripData_v4_vanilla');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (ensureIds(parsed)) data = parsed;
                }
            } catch (e) {
                console.log('Using default data');
            }
            state.tripData = data;
        }

        function saveData() {
            localStorage.setItem('busanTripData_v4_vanilla', JSON.stringify(state.tripData));
        }

        function init() {
            loadData();
            fetchWeather();
            renderTabs();
            renderTimeline();
            setupEventListeners();
        }

        // --- Rendering ---

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = days.map((day, index) => {
                const isActive = state.currentDay === index;
                const baseClass = "flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-300 border backdrop-blur-sm cursor-pointer";
                const activeClass = "bg-slate-800 text-white border-slate-800 shadow-lg shadow-slate-500/25 scale-105";
                const inactiveClass = "bg-white/60 text-slate-500 border-slate-200 hover:bg-white";
                
                return `<button onclick="switchDay(${index})" 
                        class="${baseClass} ${isActive ? activeClass : inactiveClass}">
                        ${day.name}
                    </button>`;
            }).join('');
        }

        function renderTimeline() {
            const listContainer = document.getElementById('timeline-list');
            const dayData = state.tripData[state.currentDay];
            const items = dayData ? dayData.items : [];

            const html = items.map((item, index) => {
                const isFood = item.category === 'food';
                const isLast = index === items.length - 1;
                
                // Styles
                const dotColor = isFood ? 'bg-orange-400' : 'bg-cyan-500';
                const tagBg = isFood ? 'bg-orange-50 text-orange-600' : 'bg-cyan-50 text-cyan-600';
                const tagIcon = isFood ? 'fa-solid fa-utensils' : 'fa-solid fa-location-dot';
                const iconBg = isFood ? 'bg-orange-100 text-orange-500' : 'bg-cyan-100 text-cyan-500';
                
                // Edit Mode Elements
                const dragHandle = state.isEditing ? 
                    `<div class="absolute left-[-10px] top-3 w-8 h-8 z-20 flex items-center justify-center cursor-move handle touch-none">
                        <i class="fa-solid fa-bars text-slate-400 text-lg"></i>
                     </div>` : '';
                     
                const deleteBtn = state.isEditing ? 
                    `<button onclick="deleteItem(${index}); event.stopPropagation();" 
                        class="absolute top-2 right-2 w-8 h-8 bg-red-100 text-red-500 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors z-20">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>` : '';

                const cardEditClass = state.isEditing ? 'border-2 border-dashed border-slate-300 bg-white/50 cursor-pointer' : 'hover:shadow-cyan-900/10 cursor-default';
                const contentBlurClass = state.isEditing ? 'opacity-50 blur-[0.5px] pointer-events-none' : '';
                
                // Links (only in view mode)
                let buttonsHtml = '';
                if (!state.isEditing) {
                    const uberLink = getUberLink(item);
                    const mapLink = `nmap://search?query=${item.koreanName || item.name}`;
                    const nearbyFood = `nmap://search?query=${item.koreanName || item.name} Í∑ºÏ≤ò ÎßõÏßë`;
                    const catchtableLink = `https://www.catchtable.net/search?keyword=${item.koreanName}`;
                    
                    let extras = '';
                    if (isFood) {
                         extras = `<a href="${catchtableLink}" class="h-10 rounded-xl bg-[#FF3D00] text-white text-xs font-bold flex items-center justify-center gap-1.5 shadow-md shadow-red-500/20 active:scale-95 transition-all"><i class="fa-solid fa-calendar-check"></i> Ë®Ç‰Ωç</a>
                                   <a href="${nearbyFood}" class="h-10 rounded-xl bg-white border border-slate-200 text-slate-600 text-xs font-bold flex items-center justify-center gap-1.5 shadow-sm active:scale-95 transition-all"><i class="fa-solid fa-utensils"></i> ÈôÑËøëÊõø‰ª£</a>`;
                    } else {
                         extras = `<a href="${nearbyFood}" class="h-10 rounded-xl bg-white border border-slate-200 text-slate-600 text-xs font-bold flex items-center justify-center gap-1.5 shadow-sm active:scale-95 transition-all"><i class="fa-solid fa-utensils"></i> ÈôÑËøëÁæéÈ£ü</a>
                                   <a href="nmap://search?query=${item.koreanName} Í∑ºÏ≤ò Í∞ÄÎ≥ºÎßåÌïúÍ≥≥" class="h-10 rounded-xl bg-white border border-slate-200 text-slate-600 text-xs font-bold flex items-center justify-center gap-1.5 shadow-sm active:scale-95 transition-all"><i class="fa-solid fa-map-location-dot"></i> ÈôÑËøëÊôØÈªû</a>`;
                    }

                    buttonsHtml = `
                    <div class="grid grid-cols-2 gap-2.5 mt-4">
                        <a href="${mapLink}" class="h-10 rounded-xl bg-[#03C75A] text-white text-xs font-bold flex items-center justify-center gap-1.5 shadow-md shadow-green-500/20 active:scale-95 transition-all">
                            <span class="font-black border border-white/30 w-3.5 h-3.5 rounded-sm flex items-center justify-center text-[8px]">N</span> Âú∞Âúñ
                        </a>
                        <a href="${uberLink}" class="h-10 rounded-xl bg-slate-800 text-white text-xs font-bold flex items-center justify-center gap-1.5 shadow-md shadow-slate-500/20 active:scale-95 transition-all">
                            <i class="fa-brands fa-uber"></i> Âè´Ëªä
                        </a>
                        ${extras}
                    </div>`;
                } else {
                     buttonsHtml = `<div class="absolute inset-0 flex items-center justify-center pointer-events-none"><span class="bg-white/90 text-slate-800 text-xs font-bold px-3 py-1 rounded-full shadow-sm border border-slate-200"><i class="fa-solid fa-pen mr-1"></i>ÈªûÊìäÁ∑®ËºØ</span></div>`;
                }

                // Timeline Line & Dot
                const line = (!state.isEditing && !isLast) ? `<div class="absolute left-[11px] top-8 bottom-0 w-0.5 bg-gradient-to-b from-slate-300 via-slate-200 to-transparent rounded-full"></div>` : '';
                const dot = !state.isEditing ? 
                    `<div class="absolute left-0 top-1.5 w-[22px] h-[22px] rounded-full border-[3px] border-white shadow-md z-10 flex items-center justify-center ${dotColor}">
                        <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                     </div>` : '';

                // Address Copy
                const addressAction = !state.isEditing ? `onclick="copyAddress('${item.address}')"` : '';

                return `
                <div class="relative pl-6 pb-8 last:pb-0 group sortable-item" data-id="${item.id}" onclick="${state.isEditing ? `openEditModal(${index})` : ''}">
                    ${line}
                    ${dot}
                    ${dragHandle}
                    
                    <div class="glass-card rounded-2xl p-4 shadow-lg shadow-cyan-900/5 transition-all duration-200 relative overflow-hidden ${cardEditClass}">
                        ${deleteBtn}
                        
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-3 ${contentBlurClass}">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-sm font-black text-slate-400 font-mono">${item.time}</span>
                                    <span class="px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider ${tagBg}">
                                        <i class="${tagIcon} mr-1"></i> ${isFood ? 'Food' : 'Spot'}
                                    </span>
                                </div>
                                <h3 class="text-lg font-extrabold text-slate-800 leading-tight">${item.name}</h3>
                                <div class="text-xs text-slate-400 mt-0.5 font-medium">${item.koreanName || ''}</div>
                            </div>
                            ${!state.isEditing ? `
                            <button onclick="shareLocation('${item.name}', '${item.koreanName}', '${item.address}')" 
                                class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center text-slate-400 hover:text-green-500 hover:border-green-200 hover:bg-green-50 transition-all active:scale-95 shadow-sm">
                                <i class="fa-solid fa-share-nodes text-sm"></i>
                            </button>` : ''}
                        </div>

                        <!-- Info -->
                        <div class="space-y-3 mb-4 ${contentBlurClass}">
                            <div class="flex items-start gap-2.5 text-xs">
                                <div class="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 ${iconBg}"><i class="fa-regular fa-clock"></i></div>
                                <span class="py-0.5 text-slate-600 font-medium">${item.hours}</span>
                            </div>

                            <div ${addressAction} class="group cursor-pointer flex items-start gap-2.5 p-2 rounded-lg bg-slate-50 border border-slate-100 hover:bg-blue-50 hover:border-blue-100 transition-colors active:scale-[0.98]">
                                <div class="w-5 h-5 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center flex-shrink-0 group-hover:bg-blue-200 group-hover:text-blue-600 transition-colors">
                                    <i class="fa-solid fa-map-pin text-[10px]"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-slate-600 break-all leading-relaxed">${item.address}</p>
                                </div>
                                <i class="fa-regular fa-copy text-slate-300 text-xs group-hover:text-blue-400"></i>
                            </div>

                            ${item.note ? `
                            <div class="flex items-start gap-2 text-xs">
                                <span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md font-bold whitespace-nowrap"><i class="fa-solid fa-note-sticky mr-1"></i>Á≠ÜË®ò</span>
                                <span class="py-1 text-slate-600 leading-relaxed">${item.note}</span>
                            </div>` : ''}
                        </div>

                        ${buttonsHtml}
                    </div>
                </div>`;
            }).join('');

            listContainer.innerHTML = html;

            // Handle UI changes for Edit Mode
            document.getElementById('add-btn-container').classList.toggle('hidden', !state.isEditing);
            document.getElementById('fab-container').classList.toggle('hidden', state.isEditing);
            document.getElementById('papago-link').classList.toggle('hidden', state.isEditing);
            document.getElementById('weather-display').classList.toggle('hidden', state.isEditing || !state.weather);
            
            // Toggle Edit Button Appearance
            const editBtn = document.getElementById('toggle-edit-btn');
            const editIcon = document.getElementById('edit-icon');
            if (state.isEditing) {
                editBtn.className = "w-8 h-8 rounded-full border flex items-center justify-center shadow-sm transition-all active:scale-95 bg-slate-800 text-white border-slate-800";
                editIcon.className = "fa-solid fa-check";
            } else {
                editBtn.className = "w-8 h-8 rounded-full border flex items-center justify-center shadow-sm transition-all active:scale-95 bg-white/50 hover:bg-white text-slate-600 border-slate-200";
                editIcon.className = "fa-solid fa-pen";
            }

            // Init Sortable if editing
            if (state.isEditing) {
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(listContainer, {
                    handle: '.handle',
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        const list = state.tripData[state.currentDay].items;
                        if (evt.oldIndex !== evt.newIndex) {
                            const item = list.splice(evt.oldIndex, 1)[0];
                            list.splice(evt.newIndex, 0, item);
                            saveData();
                        }
                    }
                });
            } else {
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
            }
        }

        function switchDay(index) {
            state.currentDay = index;
            renderTabs();
            renderTimeline();
        }

        // --- Logic & Actions ---

        window.toggleEditMode = function() {
            state.isEditing = !state.isEditing;
            renderTimeline();
            if (state.isEditing) showToast('ÈÄ≤ÂÖ•Á∑®ËºØÊ®°Âºè');
        }

        window.deleteItem = function(index) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë°åÁ®ãÂóéÔºü')) {
                state.tripData[state.currentDay].items.splice(index, 1);
                saveData();
                renderTimeline();
                showToast('Â∑≤Âà™Èô§');
            }
        }

        // --- Modal ---

        window.openAddModal = function() {
            state.editIndex = -1;
            state.editForm = { category: 'spot', time: '12:00', name: '', koreanName: '', address: '', note: '', hours: '' };
            updateModalUI();
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.openEditModal = function(index) {
            // Prevent opening modal when clicking on delete button
            if (event.target.closest('button')) return;
            
            state.editIndex = index;
            // Copy data
            state.editForm = JSON.parse(JSON.stringify(state.tripData[state.currentDay].items[index]));
            updateModalUI();
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function updateModalUI() {
            const form = state.editForm;
            const isAdd = state.editIndex === -1;
            
            document.getElementById('modal-title').innerText = isAdd ? 'Êñ∞Â¢ûÊôØÈªû' : 'Á∑®ËºØÊôØÈªû';
            
            // Category Buttons
            const catSpot = document.getElementById('cat-spot');
            const catFood = document.getElementById('cat-food');
            if (form.category === 'spot') {
                catSpot.className = "py-2 rounded-xl text-sm font-bold border transition-all bg-cyan-500 text-white border-cyan-500 shadow-md";
                catFood.className = "py-2 rounded-xl text-sm font-bold border transition-all bg-white text-slate-500 border-slate-200";
            } else {
                catSpot.className = "py-2 rounded-xl text-sm font-bold border transition-all bg-white text-slate-500 border-slate-200";
                catFood.className = "py-2 rounded-xl text-sm font-bold border transition-all bg-orange-500 text-white border-orange-500 shadow-md";
            }

            // Inputs
            document.getElementById('input-time').value = form.time || '';
            document.getElementById('input-name').value = form.name || '';
            document.getElementById('input-koreanName').value = form.koreanName || '';
            document.getElementById('input-address').value = form.address || '';
            document.getElementById('input-note').value = form.note || '';
            document.getElementById('input-hours').value = form.hours || '';
            
            // Naver Search Link
            const searchTerm = form.name || form.koreanName || '';
            document.getElementById('naver-search-link').href = `https://map.naver.com/p/search/${encodeURIComponent(searchTerm)}`;
        }

        window.setCategory = function(cat) {
            state.editForm.category = cat;
            updateModalUI();
        }

        window.saveItem = function() {
            const name = document.getElementById('input-name').value;
            if (!name) { showToast('Ë´ãËº∏ÂÖ•ÂêçÁ®±'); return; }

            // Gather Data
            const newItem = {
                category: state.editForm.category,
                time: document.getElementById('input-time').value,
                name: name,
                koreanName: document.getElementById('input-koreanName').value,
                address: document.getElementById('input-address').value,
                note: document.getElementById('input-note').value,
                hours: document.getElementById('input-hours').value,
                lat: state.editForm.lat,
                lng: state.editForm.lng
            };

            const items = state.tripData[state.currentDay].items;

            if (state.editIndex === -1) {
                // Create ID
                newItem.id = 'id_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                items.push(newItem);
                showToast('Â∑≤Êñ∞Â¢û');
            } else {
                // Keep ID
                newItem.id = state.editForm.id;
                items[state.editIndex] = newItem;
                showToast('Â∑≤ÂÑ≤Â≠ò');
            }

            saveData();
            closeModal();
            renderTimeline();
        }
        
        // --- Input Listeners for Real-time Search Update ---
        function setupEventListeners() {
             document.getElementById('input-name').addEventListener('input', updateModalUI);
             document.getElementById('input-koreanName').addEventListener('input', updateModalUI);
        }

        // --- Helpers ---

        async function fetchWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1796&longitude=129.0756&current_weather=true');
                const data = await response.json();
                state.weather = data.current_weather;
                
                // Update UI
                const w = state.weather;
                let icon = '‚òÄÔ∏è';
                if (w.weathercode > 1) icon = '‚õÖ';
                if (w.weathercode > 48) icon = 'üåßÔ∏è';
                
                document.getElementById('weather-icon').innerText = icon;
                document.getElementById('weather-temp').innerText = `${w.temperature}¬∞C`;
                
                if (!state.isEditing) {
                    document.getElementById('weather-display').classList.remove('hidden');
                }
            } catch (e) { console.error('Weather error'); }
        }

        window.copyAddress = function(text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Â∑≤Ë§áË£ΩÂú∞ÂùÄ');
            }).catch(() => showToast('Ë§áË£ΩÂ§±Êïó'));
        }

        window.shareLocation = function(name, koreanName, address) {
             const url = `https://map.naver.com/p/search/${encodeURIComponent(koreanName || name)}`;
             const text = `üìç ${name}\n${koreanName || ''}\n${address}`;
             if (navigator.share) {
                 navigator.share({ title: name, text: text, url: url });
             } else {
                 navigator.clipboard.writeText(`${text}\n${url}`);
                 showToast('Â∑≤Ë§áË£ΩÂàÜ‰∫´Ë≥áË®ä');
             }
        }

        function getUberLink(item) {
            const encodedName = encodeURIComponent(item.koreanName || item.name);
            if (item.lat && item.lng) {
                return `https://m.uber.com/ul/?action=setPickup&pickup=my_location&dropoff[latitude]=${item.lat}&dropoff[longitude]=${item.lng}&dropoff[nickname]=${encodedName}`;
            }
            const encodedAddr = encodeURIComponent(item.address || '');
            return `https://m.uber.com/ul/?action=setPickup&pickup=my_location&dropoff[formatted_address]=${encodedAddr}&dropoff[nickname]=${encodedName}`;
        }

        window.exploreNearby = function(type) {
            if (!navigator.geolocation) { showToast('‰∏çÊîØÊè¥ÂÆö‰Ωç'); return; }
            showToast('Ê≠£Âú®ÂÆö‰Ωç...');
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                const query = type === 'food' ? 'ÎßõÏßë' : 'Í∞ÄÎ≥ºÎßåÌïúÍ≥≥';
                window.location.href = `nmap://search?query=${query}&lat=${latitude}&lng=${longitude}`;
            }, () => showToast('ÂÆö‰ΩçÂ§±Êïó'));
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('hidden');
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 2000);
        }

        // Run
        init();

    </script>
</body>
</html>