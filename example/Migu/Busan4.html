import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { ITINERARY_DATA, DAYS } from './data';
import { WeatherData, ToastState, ItineraryItem, DaySchedule, EditModalState } from './types';
import { AmbientBackground, Toast, LocationCard, EditItemModal, MapView } from './components/Components';

// Simple ID generator
const generateId = () => Math.random().toString(36).substring(2, 9) + Date.now().toString(36);

export default function App() {
    const [currentDayId, setCurrentDayId] = useState<number>(0);
    const [weather, setWeather] = useState<WeatherData | null>(null);
    const [toast, setToast] = useState<ToastState>({ show: false, message: '' });
    const [viewMode, setViewMode] = useState<'list' | 'map'>('list');
    
    // --- State Management for Data ---
    const [allData, setAllData] = useState<Record<number, DaySchedule>>(() => {
        try {
            const saved = localStorage.getItem('busan_itinerary');
            let data = saved ? JSON.parse(saved) : ITINERARY_DATA;
            
            // Ensure every item has a unique ID for React keys
            Object.keys(data).forEach(dayId => {
                data[dayId].items = data[dayId].items.map((item: ItineraryItem) => ({
                    ...item,
                    id: item.id || generateId()
                }));
            });
            
            return data;
        } catch (e) {
            console.error("Failed to load from storage", e);
            // Fallback Init
            const fallback = JSON.parse(JSON.stringify(ITINERARY_DATA));
             Object.keys(fallback).forEach(dayId => {
                fallback[dayId].items = fallback[dayId].items.map((item: ItineraryItem) => ({
                    ...item,
                    id: item.id || generateId()
                }));
            });
            return fallback;
        }
    });

    const [isEditMode, setIsEditMode] = useState(false);
    const [draggedItemIndex, setDraggedItemIndex] = useState<number | null>(null);
    
    const [modalState, setModalState] = useState<EditModalState>({
        isOpen: false,
        mode: 'create',
        dayId: 0,
        itemIndex: -1
    });

    // Save to LocalStorage whenever allData changes
    useEffect(() => {
        localStorage.setItem('busan_itinerary', JSON.stringify(allData));
    }, [allData]);

    const currentDayData = useMemo(() => allData[currentDayId], [allData, currentDayId]);

    // --- Weather ---
    useEffect(() => {
        const fetchWeather = async () => {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1796&longitude=129.0756&current_weather=true');
                const data = await res.json();
                setWeather(data.current_weather);
            } catch (e) {
                console.error("Weather fetch failed");
            }
        };
        fetchWeather();
    }, []);

    const weatherIcon = useMemo(() => {
        if (!weather) return '‚òÄÔ∏è';
        const code = weather.weathercode;
        if (code <= 1) return '‚òÄÔ∏è';
        if (code <= 3) return '‚õÖ';
        if (code <= 48) return 'üå´Ô∏è';
        if (code <= 67) return 'üåßÔ∏è';
        if (code <= 77) return '‚ùÑÔ∏è';
        return 'üå¶Ô∏è';
    }, [weather]);

    // --- Helper: Recalculate Times ---
    // Automatically assigns time based on order. 
    // Starts at 10:00. Food = +1.5hr, Spot = +2hr.
    const recalculateTimes = (items: ItineraryItem[]): ItineraryItem[] => {
        let currentTime = 10 * 60; // 10:00 AM in minutes
        
        return items.map((item, index) => {
            if (index === 0) {
                // First item always 10:00 (or keep its original if manually set? Let's normalize for now)
                currentTime = 10 * 60; 
            }
            
            const hours = Math.floor(currentTime / 60);
            const mins = currentTime % 60;
            const timeString = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            
            // Advance time for next item
            const duration = item.category === 'food' ? 90 : 120; // 90 mins for food, 120 for spot
            currentTime += duration;

            return { ...item, time: timeString };
        });
    };

    // --- Actions ---
    const showToast = useCallback((msg: string) => {
        setToast({ show: true, message: msg });
        setTimeout(() => setToast(prev => ({ ...prev, show: false })), 2000);
    }, []);

    const handleCopy = useCallback((text: string) => {
        navigator.clipboard.writeText(text).then(() => showToast('Â∑≤Ë§áË£ΩËá≥Ââ™Ë≤ºÁ∞ø'));
    }, [showToast]);

    const handleShare = useCallback(async (item: ItineraryItem) => {
        const url = `https://map.naver.com/p/search/${encodeURIComponent(item.koreanName)}`;
        const shareData = {
            title: item.name,
            text: `üìç ${item.name}\n${item.koreanName}\n${item.address}`,
            url: url
        };
        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
                showToast('Â∑≤Ë§áË£ΩÂú∞ÈªûË≥áË®ä');
            }
        } catch (err) {
            console.log('Share dismissed');
        }
    }, [showToast]);

    const exploreNearby = useCallback((type: 'food' | 'spot') => {
        if (!navigator.geolocation) {
            showToast("ÊÇ®ÁöÑË£ùÁΩÆ‰∏çÊîØÊè¥ÂÆö‰Ωç");
            return;
        }
        showToast("Ê≠£Âú®Áç≤Âèñ‰ΩçÁΩÆ...");
        navigator.geolocation.getCurrentPosition((pos) => {
            const { latitude, longitude } = pos.coords;
            const query = type === 'food' ? 'ÎßõÏßë' : 'Í∞ÄÎ≥ºÎßåÌïúÍ≥≥';
            window.location.href = `nmap://search?query=${encodeURIComponent(query)}&lat=${latitude}&lng=${longitude}`;
        }, () => {
            showToast("ÁÑ°Ê≥ïÁç≤Âèñ‰ΩçÁΩÆÔºåË´ãÊ™¢Êü•Ê¨äÈôê");
        });
    }, [showToast]);

    // --- Data Manipulation ---
    const updateDayItems = (dayId: number, newItems: ItineraryItem[]) => {
        // Auto reschedule times whenever list changes
        const rescheduledItems = recalculateTimes(newItems);
        
        setAllData(prev => ({
            ...prev,
            [dayId]: {
                ...prev[dayId],
                items: rescheduledItems
            }
        }));
    };

    // --- Drag and Drop Handlers ---
    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedItemIndex(index);
        e.dataTransfer.effectAllowed = "move";
        // Ghost image tweaks if needed
    };

    const handleDragOver = (e: React.DragEvent, index: number) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
    };

    const handleDrop = (e: React.DragEvent, dropIndex: number) => {
        e.preventDefault();
        if (draggedItemIndex === null || draggedItemIndex === dropIndex) return;

        const items = [...currentDayData.items];
        const [movedItem] = items.splice(draggedItemIndex, 1);
        items.splice(dropIndex, 0, movedItem);

        updateDayItems(currentDayId, items);
        setDraggedItemIndex(null);
    };

    const handleDelete = (id: string | undefined) => {
        if (!id) return;
        if (window.confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü')) {
            const items = currentDayData.items.filter(item => item.id !== id);
            updateDayItems(currentDayId, items);
        }
    };

    const openEditModal = (index: number) => {
        setModalState({
            isOpen: true,
            mode: 'edit',
            dayId: currentDayId,
            itemIndex: index,
            initialData: currentDayData.items[index]
        });
    };

    const openCreateModal = () => {
        setModalState({
            isOpen: true,
            mode: 'create',
            dayId: currentDayId,
            itemIndex: -1
        });
    };

    const handleSaveItem = (item: ItineraryItem) => {
        // Ensure new item has ID
        const itemWithId = { ...item, id: item.id || generateId() };
        
        const items = [...currentDayData.items];
        if (modalState.mode === 'create') {
            items.push(itemWithId);
        } else {
            items[modalState.itemIndex] = itemWithId;
        }
        updateDayItems(currentDayId, items);
    };

    return (
        <div className="relative min-h-screen pb-24 text-slate-800 antialiased selection:bg-cyan-200 selection:text-cyan-900">
            <AmbientBackground />
            
            {/* Header */}
            <header className="fixed top-0 inset-x-0 z-50 bg-white/70 backdrop-blur-md border-b border-white/40 shadow-sm transition-all duration-300 pt-safe">
                <div className="max-w-md mx-auto px-5 py-3 flex justify-between items-center">
                    <div>
                        <h1 className="text-xl font-black tracking-tight text-slate-900 flex items-center gap-2">
                            <i className="fa-solid fa-plane-departure text-cyan-600"></i>
                            Busan <span className="text-cyan-600">2025</span>
                        </h1>
                        <p className="text-[10px] font-medium text-slate-500 tracking-wider uppercase">Flagship Travel Assistant</p>
                    </div>

                    <div className="flex items-center gap-2">
                        {/* Papago App Link */}
                        <a href="papago://" 
                           className="w-8 h-8 rounded-full border border-slate-200 bg-white/50 flex items-center justify-center text-slate-500 hover:bg-white shadow-sm transition-all active:scale-95">
                           <i className="fa-solid fa-language text-sm"></i>
                        </a>

                         {/* View Toggle */}
                         <button onClick={() => setViewMode(viewMode === 'list' ? 'map' : 'list')}
                            className={`w-8 h-8 rounded-full border flex items-center justify-center shadow-sm transition-all active:scale-95 ${
                                viewMode === 'map'
                                ? 'bg-cyan-600 text-white border-cyan-600'
                                : 'bg-white/50 border-slate-200 text-slate-500 hover:bg-white'
                            }`}>
                            <i className={`fa-solid ${viewMode === 'map' ? 'fa-list-ul' : 'fa-map'} text-sm`}></i>
                         </button>

                         {/* Edit Toggle (Only in list mode) */}
                         {viewMode === 'list' && (
                             <button onClick={() => setIsEditMode(!isEditMode)} 
                                className={`w-8 h-8 rounded-full border flex items-center justify-center shadow-sm transition-all active:scale-95 ${
                                    isEditMode 
                                    ? 'bg-slate-800 text-white border-slate-800' 
                                    : 'bg-white/50 border-slate-200 text-slate-500 hover:bg-white'
                                }`}>
                                <i className={`fa-solid ${isEditMode ? 'fa-check' : 'fa-pen'} text-sm`}></i>
                            </button>
                        )}
                        
                        <div className="flex items-center gap-1.5 bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-2 py-1 rounded-lg shadow-md shadow-cyan-500/20 min-w-[60px] justify-center">
                            {weather ? (
                                <>
                                    <span className="text-base">{weatherIcon}</span>
                                    <span className="font-bold text-xs">{weather.temperature}¬∞C</span>
                                </>
                            ) : (
                                <div className="animate-pulse h-4 w-8 bg-white/30 rounded"></div>
                            )}
                        </div>
                    </div>
                </div>

                {/* Tabs */}
                <div className="max-w-md mx-auto px-4 pb-3 pt-1">
                    <div className="flex space-x-2 overflow-x-auto hide-scrollbar pb-1">
                        {DAYS.map((day) => (
                            <button key={day.id}
                                onClick={() => setCurrentDayId(day.id)}
                                className={`flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-300 border backdrop-blur-sm ${
                                    currentDayId === day.id
                                    ? 'bg-slate-800 text-white border-slate-800 shadow-lg shadow-slate-500/25 scale-105' 
                                    : 'bg-white/60 text-slate-500 border-slate-200 hover:bg-white'
                                }`}>
                                {day.name}
                            </button>
                        ))}
                    </div>
                </div>
            </header>

            {/* Main Content */}
            <main className="max-w-md mx-auto px-5 pt-36 space-y-8">
                {viewMode === 'map' ? (
                    <div className="animate-[fade_0.3s_ease-out]">
                        <MapView items={currentDayData.items} />
                    </div>
                ) : (
                    <div className="animate-[slide-up_0.3s_ease-out]">
                         {currentDayData.items.map((item, index) => (
                            <div key={item.id} className="relative pl-6 pb-8 last:pb-0">
                                {/* Timeline Line */}
                                {index !== currentDayData.items.length - 1 && (
                                    <div className="absolute left-[11px] top-8 bottom-0 w-0.5 bg-gradient-to-b from-slate-300 via-slate-200 to-transparent rounded-full"></div>
                                )}
                                
                                {/* Timeline Dot */}
                                <div className={`absolute left-0 top-1.5 w-[22px] h-[22px] rounded-full border-[3px] border-white shadow-md z-10 flex items-center justify-center transition-colors ${
                                    isEditMode ? 'bg-slate-400' : (item.category === 'food' ? 'bg-orange-400' : 'bg-cyan-500')
                                }`}>
                                    <div className="w-1.5 h-1.5 bg-white rounded-full"></div>
                                </div>

                                {/* Card */}
                                <LocationCard 
                                    item={item} 
                                    onCopy={handleCopy} 
                                    onShare={handleShare}
                                    isEditMode={isEditMode}
                                    onEdit={() => openEditModal(index)}
                                    onDelete={() => handleDelete(item.id)}
                                    isFirst={index === 0}
                                    isLast={index === currentDayData.items.length - 1}
                                    onDragStart={(e) => handleDragStart(e, index)}
                                    onDragOver={(e) => handleDragOver(e, index)}
                                    onDrop={(e) => handleDrop(e, index)}
                                />
                            </div>
                        ))}
                    </div>
                )}

                {/* Add Button (Edit Mode Only & List View Only) */}
                {isEditMode && viewMode === 'list' && (
                    <button onClick={openCreateModal} className="w-full py-4 rounded-2xl border-2 border-dashed border-slate-300 text-slate-400 font-bold flex items-center justify-center gap-2 hover:border-slate-400 hover:text-slate-500 hover:bg-slate-50 transition-all active:scale-95">
                        <i className="fa-solid fa-plus"></i>
                        Êñ∞Â¢ûË°åÁ®ã (Ëá™ÂãïÊéíÁ®ã)
                    </button>
                )}

                <div className="h-12 flex items-center justify-center text-slate-400 text-xs pb-4">
                    Made with <i className="fa-solid fa-heart mx-1 text-red-300"></i> for Busan 2025
                </div>
            </main>

            {/* FABs (Hidden in Edit Mode or Map View) */}
            {!isEditMode && viewMode === 'list' && (
                <div className="fixed bottom-6 right-5 flex flex-col gap-3 z-40">
                    <button onClick={() => exploreNearby('food')}
                        className="w-12 h-12 rounded-full bg-amber-500 text-white shadow-lg shadow-amber-500/40 flex items-center justify-center hover:scale-110 active:scale-95 transition-all">
                        <i className="fa-solid fa-utensils"></i>
                    </button>
                    <button onClick={() => exploreNearby('spot')}
                        className="w-14 h-14 rounded-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-xl shadow-cyan-500/40 flex items-center justify-center hover:scale-110 active:scale-95 transition-all">
                        <i className="fa-solid fa-compass text-2xl"></i>
                    </button>
                </div>
            )}

            {/* Modals */}
            <EditItemModal 
                isOpen={modalState.isOpen} 
                mode={modalState.mode}
                initialData={modalState.initialData}
                onClose={() => setModalState(prev => ({ ...prev, isOpen: false }))}
                onSave={handleSaveItem}
            />
            <Toast toast={toast} />
        </div>
    );
}